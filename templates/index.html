{% extends 'base.html' %}

{% block content %}
<h1>üè¶ Your Profile</h1>
        <p style="text-align: center; color: #6b7280; margin-bottom: 40px;">
            Get personalized credit card recommendations based on your spending patterns
        </p>

        <!-- Spending Profile Section -->
        <div class="section">
            <h2>üí∞ Your Spending Profile</h2>
            <form id="spendingForm">
                <div class="grid">
                    <div class="form-group">
                        <label>Monthly Groceries Spending ($)</label>
                        <input type="number" id="groceries" placeholder="500" min="0" step="10">
                    </div>
                    <div class="form-group">
                        <label>Monthly Dining Spending ($)</label>
                        <input type="number" id="dining" placeholder="300" min="0" step="10">
                    </div>
                    <div class="form-group">
                        <label>Monthly Travel Spending ($)</label>
                        <input type="number" id="travel" placeholder="200" min="0" step="10">
                    </div>
                    <div class="form-group">
                        <label>Monthly Gas Spending ($)</label>
                        <input type="number" id="gas" placeholder="150" min="0" step="10">
                    </div>
                    <div class="form-group">
                        <label>Monthly Online Shopping ($)</label>
                        <input type="number" id="online_shopping" placeholder="250" min="0" step="10">
                    </div>
                    <div class="form-group">
                        <label>Other Monthly Spending ($)</label>
                        <input type="number" id="general" placeholder="800" min="0" step="10">
                    </div>
                </div>
            </form>
        </div>

        <!-- Filters Section -->
        <div class="section">
            <h2>üîç Preferences</h2>
            <div class="grid">
                <div class="form-group">
                    <label>Preferred Issuer</label>
                    <select id="issuer">
                        <option value="">Any Issuer</option>
                        <option value="Chase">Chase</option>
                        <option value="American Express">American Express</option>
                        <option value="Capital One">Capital One</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reward Type</label>
                    <select id="rewardType" required>
                        <option value="Points" selected>Points</option>
                        <option value="Miles">Miles</option>
                        <option value="Cashback">Cashback</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Maximum Annual Fee ($)</label>
                    <input type="number" id="maxFee" placeholder="95" min="0" step="25">
                </div>
                <div class="form-group">
                    <label>Max Recommendations</label>
                    <select id="maxRecs">
                        <option value="3">3 cards</option>
                        <option value="5" selected>5 cards</option>
                        <option value="10">10 cards</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div style="text-align: center; margin: 30px 0;">
            <button onclick="getRecommendations()" style="font-size: 18px; padding: 16px 32px;">
                üöÄ Get My Roadmap
            </button>
        </div>

        <!-- Results Section -->
        <div id="results"></div>
    </div>

    <script>
        let spendingCategories = {};

        async function loadData() {
            try {
                // Load spending categories
                const categoriesResponse = await fetch(`${API_BASE}/cards/spending-categories/`);
                const categories = await categoriesResponse.json();
                categories.forEach(cat => {
                    spendingCategories[cat.slug] = cat.id;
                });
                
                // Load saved spending and preferences
                await loadSavedData();
                
                // Set up auto-save listeners after data is loaded
                setupAutoSave();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadSavedData() {
            try {
                // Wait for user state to be initialized
                await initUserState();
                
                // Load spending data
                const savedSpending = await UserDataManager.getSpending();
                Object.keys(savedSpending).forEach(categorySlug => {
                    const amount = savedSpending[categorySlug];
                    const input = document.getElementById(categorySlug);
                    if (input && amount) {
                        input.value = amount;
                    }
                });
                
                // Load preferences
                const savedPreferences = await UserDataManager.getPreferences();
                if (savedPreferences.default_issuer_filter) {
                    const issuerSelect = document.getElementById('issuer');
                    if (issuerSelect) issuerSelect.value = savedPreferences.default_issuer_filter;
                }
                if (savedPreferences.default_reward_type_filter) {
                    const rewardTypeSelect = document.getElementById('rewardType');
                    if (rewardTypeSelect) rewardTypeSelect.value = savedPreferences.default_reward_type_filter;
                }
                if (savedPreferences.default_max_fee_filter) {
                    const maxFeeInput = document.getElementById('maxFee');
                    if (maxFeeInput) maxFeeInput.value = savedPreferences.default_max_fee_filter;
                }
                if (savedPreferences.default_max_recommendations) {
                    const maxRecsSelect = document.getElementById('maxRecs');
                    if (maxRecsSelect) maxRecsSelect.value = savedPreferences.default_max_recommendations;
                }
            } catch (error) {
                console.error('Error loading saved data:', error);
            }
        }

        async function saveCurrentData() {
            try {
                // Save spending data
                const spendingData = {};
                Object.keys(spendingCategories).forEach(slug => {
                    const input = document.getElementById(slug);
                    if (input && input.value) {
                        spendingData[slug] = parseFloat(input.value) || 0;
                    }
                });
                
                // Save preferences
                const preferencesData = {
                    default_issuer_filter: document.getElementById('issuer')?.value || '',
                    default_reward_type_filter: document.getElementById('rewardType')?.value || '',
                    default_max_fee_filter: parseFloat(document.getElementById('maxFee')?.value) || null,
                    default_max_recommendations: parseInt(document.getElementById('maxRecs')?.value) || 5
                };
                
                // Use the unified data manager to save
                await UserDataManager.saveSpending(spendingData);
                
                // For preferences, we need to save them separately since UserDataManager 
                // doesn't have a savePreferences method yet
                if (isAuthenticated) {
                    try {
                        await fetch(`${API_BASE}/users/data/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                spending: spendingData,
                                cards: await UserDataManager.getCards(),
                                preferences: preferencesData
                            })
                        });
                    } catch (error) {
                        console.error('Error saving to server:', error);
                    }
                } else {
                    // Save preferences to localStorage for anonymous users
                    localStorage.setItem('userPreferences', JSON.stringify(preferencesData));
                }
                
            } catch (error) {
                console.error('Error saving current data:', error);
            }
        }

        async function getRecommendations() {
            // Save current data before getting recommendations
            await saveCurrentData();
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">üîÑ Analyzing your profile and generating recommendations...</div>';

            try {
                // Build spending amounts object
                const spendingAmounts = {};
                Object.keys(spendingCategories).forEach(slug => {
                    const amount = document.getElementById(slug)?.value;
                    if (amount && amount > 0) {
                        spendingAmounts[spendingCategories[slug]] = parseFloat(amount);
                    }
                });

                // Build user cards array from saved data
                const userCardIds = await UserDataManager.getCards();
                const userCards = userCardIds.map(cardId => ({
                    card_id: cardId,
                    opened_date: '2023-01-01', // Default date
                    nickname: '',
                    is_active: true
                }));

                // Build filters array
                const filters = [];
                const issuer = document.getElementById('issuer').value;
                const rewardType = document.getElementById('rewardType').value;
                const maxFee = document.getElementById('maxFee').value;

                if (issuer) {
                    filters.push({
                        name: 'Issuer Filter',
                        filter_type: 'issuer',
                        value: issuer
                    });
                }
                if (rewardType) {
                    filters.push({
                        name: 'Reward Type Filter',
                        filter_type: 'reward_type',
                        value: rewardType
                    });
                }
                if (maxFee) {
                    filters.push({
                        name: 'Annual Fee Filter',
                        filter_type: 'annual_fee',
                        value: `0-${maxFee}`
                    });
                }

                const requestData = {
                    spending_amounts: spendingAmounts,
                    user_cards: userCards,
                    filters: filters,
                    max_recommendations: parseInt(document.getElementById('maxRecs').value)
                };

                const response = await fetch(`${API_BASE}/roadmaps/quick-recommendation/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                    return;
                }

                // Display recommendations
                const recommendations = data.recommendations || [];
                const totalValue = data.total_estimated_rewards || 0;

                let html = `
                    <div class="results">
                        <h2>üéØ Your Personalized Credit Card Roadmap</h2>
                        <p style="background: #10b981; color: white; padding: 15px; border-radius: 8px; text-align: center; font-size: 18px; font-weight: 600;">
                            üí∞ Total Estimated First-Year Value: $${totalValue.toFixed(0)}
                        </p>
                `;

                if (recommendations.length === 0) {
                    html += '<p>No recommendations found with your current criteria. Try adjusting your filters.</p>';
                } else {
                    recommendations.forEach((rec, index) => {
                        const actionClass = rec.action.toLowerCase();
                        const actionEmoji = {
                            'apply': '‚úÖ',
                            'keep': 'üëç',
                            'cancel': '‚ùå',
                            'upgrade': '‚¨ÜÔ∏è',
                            'downgrade': '‚¨áÔ∏è'
                        }[rec.action] || 'üìã';

                        // Generate rewards breakdown HTML
                        let breakdownHtml = '';
                        if (rec.rewards_breakdown && rec.rewards_breakdown.length > 0) {
                            breakdownHtml = '<div style="margin-top: 15px;"><strong>Rewards Breakdown:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                            rec.rewards_breakdown.forEach(breakdown => {
                                breakdownHtml += `<li style="margin: 2px 0; font-family: monospace; font-size: 13px;">${breakdown.category_name}: ${breakdown.calculation}</li>`;
                            });
                            breakdownHtml += '</ul></div>';
                        }

                        html += `
                            <div class="recommendation ${actionClass}">
                                <div style="display: flex; justify-content: between; align-items: start;">
                                    <div>
                                        <h3>${actionEmoji} ${rec.action.toUpperCase()}: ${rec.card.issuer} ${rec.card.name}</h3>
                                        <p><strong>Estimated Value:</strong> $${rec.estimated_rewards.toFixed(0)}</p>
                                        <p><strong>Annual Fee:</strong> $${rec.card.annual_fee}</p>
                                        ${rec.card.signup_bonus_amount ? 
                                            `<p><strong>Signup Bonus:</strong> ${rec.card.signup_bonus_amount} points/miles</p>` : ''
                                        }
                                        ${breakdownHtml}
                                        <p><strong>Why:</strong> ${rec.reasoning}</p>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="background: rgba(255,255,255,0.7); padding: 8px 12px; border-radius: 20px; font-weight: 600; text-align: center;">
                                            #${rec.priority}
                                        </div>
                                        ${rec.action === 'apply' ? 
                                            `<button onclick="toggleCardOwnership(${rec.card.id}, this)" style="padding: 6px 12px; font-size: 12px; background: #10b981;">
                                                ‚úÖ I have this card
                                            </button>` : ''
                                        }
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                html += '</div>';
                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = '<div class="error">Error generating recommendations. Please try again.</div>';
                console.error('Error:', error);
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Load initial data when page loads
        loadData();
        
        // Auto-save when user navigates away
        window.addEventListener('beforeunload', function(e) {
            // Save data synchronously (limited time available)
            try {
                const spendingData = {};
                Object.keys(spendingCategories).forEach(slug => {
                    const input = document.getElementById(slug);
                    if (input && input.value) {
                        spendingData[slug] = parseFloat(input.value) || 0;
                    }
                });
                
                const preferencesData = {
                    default_issuer_filter: document.getElementById('issuer')?.value || '',
                    default_reward_type_filter: document.getElementById('rewardType')?.value || '',
                    default_max_fee_filter: parseFloat(document.getElementById('maxFee')?.value) || null,
                    default_max_recommendations: parseInt(document.getElementById('maxRecs')?.value) || 5
                };
                
                // Use localStorage for immediate saving (works in beforeunload)
                localStorage.setItem('userSpending', JSON.stringify(spendingData));
                localStorage.setItem('userPreferences', JSON.stringify(preferencesData));
                
                // If authenticated, try to save to server (may not complete)
                if (isAuthenticated) {
                    navigator.sendBeacon(`${API_BASE}/users/data/`, JSON.stringify({
                        spending: spendingData,
                        cards: JSON.parse(localStorage.getItem('userCards') || '[]'),
                        preferences: preferencesData
                    }));
                }
            } catch (error) {
                console.error('Error in beforeunload save:', error);
            }
        });
        
        // Auto-save on form changes (debounced)
        let saveTimeout;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveCurrentData, 1000); // Save 1 second after last change
        }
        
        function setupAutoSave() {
            // Add listeners to spending inputs
            Object.keys(spendingCategories).forEach(slug => {
                const input = document.getElementById(slug);
                if (input) {
                    input.addEventListener('input', debouncedSave);
                    input.addEventListener('change', debouncedSave);
                }
            });
            
            // Add listeners to preference inputs
            const preferenceInputs = ['issuer', 'rewardType', 'maxFee', 'maxRecs'];
            preferenceInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('change', debouncedSave);
                }
            });
        }
        
    </script>
{% endblock %}

{% block extra_js %}{% endblock %}