{% extends 'base.html' %}

{% block title %}Create a Roadmap - Credit Card Guru{% endblock %}

{% block content %}
<h1>üó∫Ô∏è Create a Roadmap</h1>
        <p style="text-align: center; color: #6b7280; margin-bottom: 40px;">
            Get personalized credit card recommendations based on your spending patterns
        </p>

        <!-- Preferences Section (moved to top) -->
        <div class="section">
            <h2>üîç Preferences</h2>
            <div class="grid">
                <div class="form-group">
                    <label>Card Type</label>
                    <select id="cardType">
                        <option value="personal" selected>Personal</option>
                        <option value="business">Business</option>
                        <option value="all">All Types</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Preferred Issuer</label>
                    <select id="issuer">
                        <option value="">Any Issuer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reward Type</label>
                    <select id="rewardType" required>
                        <option value="Points" selected>Points</option>
                        <option value="Miles">Miles</option>
                        <option value="Cashback">Cashback</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Maximum Annual Fee ($)</label>
                    <input type="number" id="maxFee" placeholder="95" min="0" step="25">
                </div>
                <div class="form-group">
                    <label>Max Recommendations</label>
                    <select id="maxRecs">
                        <option value="3">3 cards</option>
                        <option value="5" selected>5 cards</option>
                        <option value="10">10 cards</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Spending Profile Section (made collapsible) -->
        <div class="section">
            <h2 onclick="toggleSpendingProfile()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                üí∞ Your Spending Profile
                <span id="spendingToggle" style="font-size: 14px; color: #6b7280;">‚ñº Click to expand</span>
            </h2>
            <div id="spendingProfileContent" style="display: none;">
                <form id="spendingForm">
                    <div id="spendingCategories" class="grid">
                        <div class="loading">üîÑ Loading spending categories...</div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                        <strong style="font-size: 18px;">Total Monthly Spending: $<span id="totalSpending">0</span></strong>
                    </div>
                </form>
            </div>
        </div>

        <!-- Action Button -->
        <div style="text-align: center; margin: 30px 0;">
            <button onclick="getRecommendations()" style="font-size: 18px; padding: 16px 32px;">
                üöÄ Get My Roadmap
            </button>
        </div>


        <!-- Results Section -->
        <div id="results"></div>
    </div>

    <script>
        // Dynamic issuer loading: 2025-07-04-v1
        let spendingCategories = {};

        function toggleSpendingProfile() {
            const content = document.getElementById('spendingProfileContent');
            const toggle = document.getElementById('spendingToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñ≤ Click to collapse';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº Click to expand';
            }
        }

        async function loadData() {
            try {
                // Load spending categories
                const categoriesResponse = await fetch(`${API_BASE}/cards/spending-categories/`);
                const categoriesData = await categoriesResponse.json();
                
                // Handle both paginated and non-paginated responses
                const categories = categoriesData.results || categoriesData;
                
                if (Array.isArray(categories)) {
                    // Sort categories by sort_order
                    categories.sort((a, b) => (a.sort_order || 100) - (b.sort_order || 100));
                    
                    // Build spending categories mapping
                    categories.forEach(cat => {
                        spendingCategories[cat.slug] = cat.id;
                    });
                    
                    // Render spending categories in the UI
                    renderSpendingCategories(categories);
                } else {
                    console.error('Categories response is not an array:', typeof categories);
                }
                
                // Load issuers for the dropdown
                await loadIssuers();
                
                // Load saved spending and preferences
                await loadSavedData();
                
                // Set up auto-save listeners after data is loaded
                setupAutoSave();
                
                // Set up total calculation
                setupTotalCalculation();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('spendingCategories').innerHTML = 
                    '<div class="error">Error loading spending categories. Please try again.</div>';
            }
        }

        async function loadIssuers() {
            try {
                const issuersResponse = await fetch(`${API_BASE}/cards/issuers/`);
                const issuersData = await issuersResponse.json();
                const issuers = issuersData.results || issuersData;
                
                const issuerSelect = document.getElementById('issuer');
                
                // Sort issuers alphabetically
                issuers.sort((a, b) => a.name.localeCompare(b.name));
                
                // Add each issuer as an option
                issuers.forEach(issuer => {
                    const option = document.createElement('option');
                    option.value = issuer.name;
                    option.textContent = issuer.name;
                    issuerSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading issuers:', error);
            }
        }

        function renderSpendingCategories(categories) {
            const container = document.getElementById('spendingCategories');
            
            // Default icons for categories
            const defaultIcons = {
                'groceries': 'üõí',
                'dining': 'üçΩÔ∏è',
                'travel': '‚úàÔ∏è',
                'gas': '‚õΩ',
                'online-shopping': 'üì¶',
                'general': 'üí≥',
                'entertainment': 'üé¨',
                'transportation': 'üöó',
                'utilities': '‚ö°',
                'drugstores': 'üíä',
                'streaming': 'üì∫',
                'home_improvement': 'üî®',
                'office_supplies': 'üìÑ',
                'telecommunications': 'üì±',
                'shopping': 'üõçÔ∏è',
                'amazon': 'üì¶',
                'other': 'üí∞'
            };
            
            const html = categories.map(category => {
                const displayName = category.display_name || category.name;
                const description = category.description || '';
                const slug = category.slug;
                
                // Handle icon - prefer emoji, fallback to Font Awesome or default
                let iconHtml = '';
                if (category.icon && category.icon.includes('fa-')) {
                    // Font Awesome icon
                    iconHtml = `<i class="${category.icon}" style="font-size: 18px; margin-right: 8px; width: 20px; text-align: center;"></i>`;
                } else if (category.icon && !category.icon.includes('fa-')) {
                    // Emoji or other text icon
                    iconHtml = `<span style="font-size: 20px; margin-right: 8px;">${category.icon}</span>`;
                } else {
                    // Default emoji based on slug
                    const defaultIcon = defaultIcons[slug] || 'üí≥';
                    iconHtml = `<span style="font-size: 20px; margin-right: 8px;">${defaultIcon}</span>`;
                }
                
                // Create a safe HTML ID by replacing hyphens with underscores
                const htmlId = slug.replace(/-/g, '_');
                
                return `
                    <div class="form-group">
                        <label for="${htmlId}">
                            ${iconHtml}
                            Monthly ${displayName} Spending ($)
                            ${description ? `<div style="font-size: 12px; color: #6b7280; font-weight: normal; margin-top: 4px;">${description}</div>` : ''}
                        </label>
                        <input type="number" id="${htmlId}" data-category-slug="${slug}" placeholder="0" min="0" step="10" class="spending-input">
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function setupTotalCalculation() {
            // Update total whenever any spending input changes
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('spending-input')) {
                    updateTotal();
                }
            });
            
            // Initial calculation
            updateTotal();
        }

        function updateTotal() {
            const spendingInputs = document.querySelectorAll('.spending-input');
            let total = 0;
            
            spendingInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            document.getElementById('totalSpending').textContent = total.toLocaleString();
        }

        async function loadSavedData() {
            try {
                // Wait for user state to be initialized
                await initUserState();
                
                // Load spending data
                const savedSpending = await UserDataManager.getSpending();
                Object.keys(savedSpending).forEach(categorySlug => {
                    const amount = savedSpending[categorySlug];
                    // Convert slug to HTML ID (replace hyphens with underscores)
                    const htmlId = categorySlug.replace(/-/g, '_');
                    const input = document.getElementById(htmlId);
                    if (input && amount) {
                        input.value = amount;
                    }
                });
                
                // Update total after loading saved data
                updateTotal();
                
                // Load preferences
                const savedPreferences = await UserDataManager.getPreferences();
                if (savedPreferences.default_issuer_filter) {
                    const issuerSelect = document.getElementById('issuer');
                    if (issuerSelect) issuerSelect.value = savedPreferences.default_issuer_filter;
                }
                if (savedPreferences.default_reward_type_filter) {
                    const rewardTypeSelect = document.getElementById('rewardType');
                    if (rewardTypeSelect) rewardTypeSelect.value = savedPreferences.default_reward_type_filter;
                }
                if (savedPreferences.default_max_fee_filter) {
                    const maxFeeInput = document.getElementById('maxFee');
                    if (maxFeeInput) maxFeeInput.value = savedPreferences.default_max_fee_filter;
                }
                if (savedPreferences.default_max_recommendations) {
                    const maxRecsSelect = document.getElementById('maxRecs');
                    if (maxRecsSelect) maxRecsSelect.value = savedPreferences.default_max_recommendations;
                }
            } catch (error) {
                console.error('Error loading saved data:', error);
            }
        }

        async function saveCurrentData() {
            try {
                // Save spending data
                const spendingData = {};
                const spendingInputs = document.querySelectorAll('.spending-input');
                spendingInputs.forEach(input => {
                    const categorySlug = input.dataset.categorySlug;
                    const value = input.value;
                    if (value && categorySlug) {
                        spendingData[categorySlug] = parseFloat(value) || 0;
                    }
                });
                
                // Save preferences
                const preferencesData = {
                    default_issuer_filter: document.getElementById('issuer')?.value || '',
                    default_reward_type_filter: document.getElementById('rewardType')?.value || '',
                    default_max_fee_filter: parseFloat(document.getElementById('maxFee')?.value) || null,
                    default_max_recommendations: parseInt(document.getElementById('maxRecs')?.value) || 5
                };
                
                // Use the unified data manager to save
                await UserDataManager.saveSpending(spendingData);
                
                // For preferences, we need to save them separately since UserDataManager 
                // doesn't have a savePreferences method yet
                if (isAuthenticated) {
                    try {
                        await fetch(`${API_BASE}/users/data/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                spending: spendingData,
                                cards: await UserDataManager.getCards(),
                                preferences: preferencesData
                            })
                        });
                    } catch (error) {
                        console.error('Error saving to server:', error);
                    }
                } else {
                    // Save preferences to localStorage for anonymous users
                    localStorage.setItem('userPreferences', JSON.stringify(preferencesData));
                }
                
            } catch (error) {
                console.error('Error saving current data:', error);
            }
        }

        async function getRecommendations() {
            // Save current data before getting recommendations
            await saveCurrentData();
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">üîÑ Analyzing your profile and generating recommendations...</div>';

            try {
                // Build spending amounts object
                const spendingAmounts = {};
                
                // Build spending amounts from dynamic inputs
                const spendingInputs = document.querySelectorAll('.spending-input');
                spendingInputs.forEach(input => {
                    const categorySlug = input.dataset.categorySlug;
                    const amount = input.value;
                    const categoryId = spendingCategories[categorySlug];
                    
                    if (amount && amount > 0 && categoryId) {
                        spendingAmounts[categoryId] = parseFloat(amount);
                    }
                });

                // Build user cards array from saved data
                const userCardIds = await UserDataManager.getCards();
                const userCards = userCardIds.map(cardId => ({
                    card_id: cardId,
                    opened_date: '2023-01-01', // Default date
                    nickname: '',
                    is_active: true
                }));

                // Build filters array
                const filters = [];
                const cardType = document.getElementById('cardType').value;
                const issuer = document.getElementById('issuer').value;
                const rewardType = document.getElementById('rewardType').value;
                const maxFee = document.getElementById('maxFee').value;

                if (cardType && cardType !== 'all') {
                    filters.push({
                        name: 'Card Type Filter',
                        filter_type: 'card_type',
                        value: cardType
                    });
                }
                if (issuer) {
                    filters.push({
                        name: 'Issuer Filter',
                        filter_type: 'issuer',
                        value: issuer
                    });
                }
                if (rewardType) {
                    filters.push({
                        name: 'Reward Type Filter',
                        filter_type: 'reward_type',
                        value: rewardType
                    });
                }
                if (maxFee) {
                    filters.push({
                        name: 'Annual Fee Filter',
                        filter_type: 'annual_fee',
                        value: `0-${maxFee}`
                    });
                }

                const requestData = {
                    spending_amounts: spendingAmounts,
                    user_cards: userCards,
                    filters: filters,
                    max_recommendations: parseInt(document.getElementById('maxRecs').value)
                };

                const response = await fetch(`${API_BASE}/roadmaps/quick-recommendation/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                    return;
                }

                // Display recommendations
                const recommendations = data.recommendations || [];
                

                let html = `
                    <div class="results">
                        <h2>üéØ Your Personalized Credit Card Roadmap</h2>
                `;

                if (recommendations.length === 0) {
                    html += '<p>No recommendations found with your current criteria. Try adjusting your filters.</p>';
                } else {
                    recommendations.forEach((rec, index) => {
                        const actionClass = rec.action.toLowerCase();
                        const actionEmoji = {
                            'apply': '‚úÖ',
                            'keep': 'üëç',
                            'cancel': '‚ùå',
                            'upgrade': '‚¨ÜÔ∏è',
                            'downgrade': '‚¨áÔ∏è'
                        }[rec.action] || 'üìã';

                        // Generate rewards breakdown HTML
                        let breakdownHtml = '';
                        
                        if (rec.rewards_breakdown && Array.isArray(rec.rewards_breakdown) && rec.rewards_breakdown.length > 0) {
                            breakdownHtml = '<div style="margin-top: 15px; background: #f8f9fa; padding: 10px; border-radius: 6px;"><strong>üí∞ Rewards Breakdown:</strong><ul style="margin: 8px 0; padding-left: 20px;">';
                            rec.rewards_breakdown.forEach(breakdown => {
                                const categoryName = breakdown.category_name || 'Unknown Category';
                                const calculation = breakdown.calculation || 'No calculation available';
                                breakdownHtml += `<li style="margin: 4px 0; font-family: monospace; font-size: 14px; color: #2563eb;"><strong>${categoryName}:</strong> ${calculation}</li>`;
                            });
                            breakdownHtml += '</ul></div>';
                        }

                        html += `
                            <div class="recommendation ${actionClass} modal-card-clickable" onclick="openCardModal(${rec.card.id})">
                                <div style="display: flex; justify-content: between; align-items: start;">
                                    <div>
                                        <h3>${actionEmoji} ${rec.action.toUpperCase()}: ${rec.card.name}</h3>
                                        <p><strong>Estimated Value:</strong> $${rec.estimated_rewards.toFixed(0)}</p>
                                        <p><strong>Annual Fee:</strong> $${rec.card.annual_fee}</p>
                                        ${rec.card.signup_bonus_amount && rec.action === 'apply' ? 
                                            `<p><strong>Signup Bonus:</strong> ${rec.card.signup_bonus_amount} points/miles</p>` : ''
                                        }
                                        ${breakdownHtml}
                                        <p><strong>Why:</strong> ${rec.reasoning}</p>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="background: rgba(255,255,255,0.7); padding: 8px 12px; border-radius: 20px; font-weight: 600; text-align: center;">
                                            #${rec.priority}
                                        </div>
                                        ${rec.action === 'apply' ? 
                                            `<button onclick="event.stopPropagation(); toggleCardOwnership(${rec.card.id}, this)" style="padding: 6px 12px; font-size: 12px; background: #10b981;">
                                                ‚úÖ I have this card
                                            </button>` : ''
                                        }
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                html += '</div>';
                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = '<div class="error">Error generating recommendations. Please try again.</div>';
                console.error('Error:', error);
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Load initial data when page loads
        loadData();
        
        // Auto-save when user navigates away
        window.addEventListener('beforeunload', function(e) {
            // Save data synchronously (limited time available)
            try {
                const spendingData = {};
                const spendingInputs = document.querySelectorAll('.spending-input');
                spendingInputs.forEach(input => {
                    const categorySlug = input.dataset.categorySlug;
                    const value = input.value;
                    if (value && categorySlug) {
                        spendingData[categorySlug] = parseFloat(value) || 0;
                    }
                });
                
                const preferencesData = {
                    default_issuer_filter: document.getElementById('issuer')?.value || '',
                    default_reward_type_filter: document.getElementById('rewardType')?.value || '',
                    default_max_fee_filter: parseFloat(document.getElementById('maxFee')?.value) || null,
                    default_max_recommendations: parseInt(document.getElementById('maxRecs')?.value) || 5
                };
                
                // Use localStorage for immediate saving (works in beforeunload)
                localStorage.setItem('userSpending', JSON.stringify(spendingData));
                localStorage.setItem('userPreferences', JSON.stringify(preferencesData));
                
                // If authenticated, try to save to server (may not complete)
                if (isAuthenticated) {
                    navigator.sendBeacon(`${API_BASE}/users/data/`, JSON.stringify({
                        spending: spendingData,
                        cards: JSON.parse(localStorage.getItem('userCards') || '[]'),
                        preferences: preferencesData
                    }));
                }
            } catch (error) {
                console.error('Error in beforeunload save:', error);
            }
        });
        
        // Auto-save on form changes (debounced)
        let saveTimeout;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveCurrentData, 1000); // Save 1 second after last change
        }
        
        function setupAutoSave() {
            // Add listeners to all spending inputs (dynamic)
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('spending-input')) {
                    debouncedSave();
                }
            });
            
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('spending-input')) {
                    debouncedSave();
                }
            });
            
            // Add listeners to preference inputs
            const preferenceInputs = ['issuer', 'rewardType', 'maxFee', 'maxRecs'];
            preferenceInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('change', debouncedSave);
                }
            });
        }
        
    </script>
{% endblock %}

{% block extra_js %}{% endblock %}