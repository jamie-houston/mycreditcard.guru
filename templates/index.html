{% extends 'base.html' %}

{% block title %}Create a Roadmap - Credit Card Guru{% endblock %}

{% block content %}
<h1>üó∫Ô∏è Create a Roadmap</h1>
        <p style="text-align: center; color: #6b7280; margin-bottom: 40px;">
            Get personalized credit card recommendations based on your spending patterns
        </p>

        <!-- Preferences Section (moved to top) -->
        <div class="section preferences-section">
            <h2 onclick="togglePreferences()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                üîç Preferences
                <span id="preferencesToggle" style="font-size: 14px; color: #6b7280;"></span>
            </h2>
            <div id="preferencesContent" class="spending-grid">
                <div class="preferences-inline">
                    <div class="input-group">
                        <span class="input-group-text">Card Type</span>
                        <select id="cardType">
                            <option value="personal" selected>Personal</option>
                            <option value="business">Business</option>
                            <option value="all">All Types</option>
                        </select>
                    </div>
                </div>
                <div class="preferences-inline">
                    <div class="input-group">
                        <span class="input-group-text">Preferred Issuer</span>
                        <select id="issuer">
                            <option value="">Any Issuer</option>
                        </select>
                    </div>
                </div>
                <div class="preferences-inline">
                    <div class="input-group">
                        <span class="input-group-text">Reward Type</span>
                        <select id="rewardType" required>
                            <option value="Points" selected>Points</option>
                            <option value="Miles">Miles</option>
                            <option value="Cashback">Cashback</option>
                        </select>
                    </div>
                </div>
                <div class="preferences-inline">
                    <div class="input-group">
                        <span class="input-group-text">Max Annual Fee</span>
                        <input type="number" id="maxFee" placeholder="95" min="0" step="25">
                    </div>
                </div>
                <div class="preferences-inline">
                    <div class="input-group">
                        <span class="input-group-text">Max Recommendations</span>
                        <select id="maxRecs">
                            <option value="3">3 cards</option>
                            <option value="5" selected>5 cards</option>
                            <option value="10">10 cards</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spending Profile Section (made collapsible) -->
        <div class="section spending-section">
            <h2 onclick="toggleSpendingProfile()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                üí∞ Your Spending Profile
                <span id="spendingToggle" style="font-size: 14px; color: #6b7280;">‚ñº Click to expand</span>
            </h2>
            <div id="spendingProfileContent" style="display: none;">
                <form id="spendingForm">
                    <div id="spendingCategories" class="spending-grid">
                        <div class="loading">üîÑ Loading spending categories...</div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                        <strong style="font-size: 18px;">Total Monthly Spending: $<span id="totalSpending">0</span></strong>
                        <div style="margin-top: 12px;">
                            <button onclick="resetSpendingProfile()" style="background: #6b7280; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                                üóëÔ∏è Reset All Data
                            </button>
                        </div>
                    </div>
                    
                    <!-- Credits Section -->
                    <div class="credits-section" style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px; color: #374151;">üí≥ Credit Preferences</h3>
                        <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
                            Select credits/benefits that are valuable to you. This helps us recommend cards with benefits you'll actually use.
                        </p>
                        <div id="creditTypes" class="credits-checkbox-list">
                            <div class="loading">üîÑ Loading credit types...</div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Action Button -->
        <div style="text-align: center; margin: 30px 0;">
            <button onclick="getRecommendations()" class="action-button" style="font-size: 18px; padding: 16px 32px;">
                üöÄ Get My Roadmap
            </button>
        </div>


        <!-- Results Section -->
        <div id="results"></div>
    </div>

    <script>
        // Dynamic issuer loading: 2025-07-04-v1
        let spendingCategories = {};

        function toggleSpendingProfile() {
            const content = document.getElementById('spendingProfileContent');
            const toggle = document.getElementById('spendingToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñ≤ Click to collapse';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº Click to expand';
            }
        }

        function togglePreferences() {
            const content = document.getElementById('preferencesContent');
            const toggle = document.getElementById('preferencesToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'grid';
                toggle.textContent = '‚ñ≤ Click to collapse';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº Click to expand';
            }
        }

        async function loadData() {
            try {
                // Load spending categories
                const categoriesResponse = await fetch(`${API_BASE}/cards/spending-categories/`);
                const categoriesData = await categoriesResponse.json();
                
                // Handle both paginated and non-paginated responses
                const categories = categoriesData.results || categoriesData;
                
                if (Array.isArray(categories)) {
                    // Sort categories by sort_order
                    categories.sort((a, b) => (a.sort_order || 100) - (b.sort_order || 100));
                    
                    // Build spending categories mapping
                    categories.forEach(cat => {
                        spendingCategories[cat.slug] = cat.id;
                    });
                    
                    // Render spending categories in the UI
                    renderSpendingCategories(categories);
                } else {
                    console.error('Categories response is not an array:', typeof categories);
                }
                
                // Load issuers for the dropdown
                await loadIssuers();
                
                // Load credit types for preferences
                await loadCreditTypes();
                
                // Load saved spending and preferences
                await loadSavedData();
                
                // Set up auto-save listeners after data is loaded
                setupAutoSave();
                
                // Set up total calculation
                setupTotalCalculation();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('spendingCategories').innerHTML = 
                    '<div class="error">Error loading spending categories. Please try again.</div>';
            }
        }

        async function loadIssuers() {
            try {
                const issuersResponse = await fetch(`${API_BASE}/cards/issuers/`);
                const issuersData = await issuersResponse.json();
                const issuers = issuersData.results || issuersData;
                
                const issuerSelect = document.getElementById('issuer');
                
                // Sort issuers alphabetically
                issuers.sort((a, b) => a.name.localeCompare(b.name));
                
                // Add each issuer as an option
                issuers.forEach(issuer => {
                    const option = document.createElement('option');
                    option.value = issuer.name;
                    option.textContent = issuer.name;
                    issuerSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading issuers:', error);
            }
        }

        async function loadCreditTypes() {
            try {
                const creditTypesResponse = await fetch(`${API_BASE}/cards/credit-types/`);
                const creditTypesData = await creditTypesResponse.json();
                const creditTypes = creditTypesData.results || creditTypesData;
                
                // Group credit types by category
                const categorizedCredits = {};
                creditTypes.forEach(creditType => {
                    const category = creditType.category || 'misc';
                    if (!categorizedCredits[category]) {
                        categorizedCredits[category] = [];
                    }
                    categorizedCredits[category].push(creditType);
                });
                
                // Render credit types
                renderCreditTypes(categorizedCredits);
                
            } catch (error) {
                console.error('Error loading credit types:', error);
                document.getElementById('creditTypes').innerHTML = 
                    '<div class="error">Error loading credit types. Please try again.</div>';
            }
        }

        function renderSpendingCategories(categories) {
            const container = document.getElementById('spendingCategories');
            
            // Default icons for categories
            const defaultIcons = {
                'groceries': 'üõí',
                'dining': 'üçΩÔ∏è',
                'travel': '‚úàÔ∏è',
                'gas': '‚õΩ',
                'online-shopping': 'üì¶',
                'general': 'üí≥',
                'entertainment': 'üé¨',
                'transportation': 'üöó',
                'utilities': '‚ö°',
                'drugstores': 'üíä',
                'streaming': 'üì∫',
                'home_improvement': 'üî®',
                'office_supplies': 'üìÑ',
                'telecommunications': 'üì±',
                'shopping': 'üõçÔ∏è',
                'amazon': 'üì¶',
                'other': 'üí∞'
            };
            
            // Filter to only show parent categories (no parent field)
            const parentCategories = categories.filter(cat => !cat.parent);
            
            const html = parentCategories.map(category => {
                const displayName = category.display_name || category.name;
                const description = category.description || '';
                const slug = category.slug;
                
                // Handle icon - prefer emoji, fallback to Font Awesome or default
                let iconHtml = '';
                if (category.icon && category.icon.includes('fa-')) {
                    // Font Awesome icon
                    iconHtml = `<i class="${category.icon}" style="font-size: 18px; margin-right: 8px; width: 20px; text-align: center;"></i>`;
                } else if (category.icon && !category.icon.includes('fa-')) {
                    // Emoji or other text icon
                    iconHtml = `<span style="font-size: 20px; margin-right: 8px;">${category.icon}</span>`;
                } else {
                    // Default emoji based on slug
                    const defaultIcon = defaultIcons[slug] || 'üí≥';
                    iconHtml = `<span style="font-size: 20px; margin-right: 8px;">${defaultIcon}</span>`;
                }
                
                // Create a safe HTML ID by replacing hyphens with underscores
                const htmlId = slug.replace(/-/g, '_');
                
                // Create tooltip for description
                const tooltipHtml = description ? 
                    `<span class="tooltip-icon" title="${description}">‚ùì</span>` : '';
                
                let categoryHtml = `
                    <div class="spending-item">
                        <div class="input-group">
                            <span class="input-group-text fw-bold" style="min-width: 140px;">
                                ${iconHtml}${displayName} ${tooltipHtml}
                            </span>
                            <span class="input-group-text">$</span>
                            <input type="number" id="${htmlId}" data-category-slug="${slug}" 
                                   placeholder="0" min="0" step="10" class="form-control spending-input">
                        </div>
                    </div>
                `;
                
                // Add subcategories if they exist
                if (category.subcategories && category.subcategories.length > 0) {
                    category.subcategories.forEach(subcat => {
                        const subDisplayName = subcat.display_name || subcat.name;
                        const subSlug = subcat.slug;
                        const subHtmlId = subSlug.replace(/-/g, '_');
                        const subDescription = subcat.description || '';
                        const subTooltipHtml = subDescription ? 
                            `<span class="tooltip-icon" title="${subDescription}">‚ùì</span>` : '';
                        
                        // Handle subcategory icon
                        let subIconHtml = '';
                        if (subcat.icon && subcat.icon.includes('fa-')) {
                            subIconHtml = `<i class="${subcat.icon}" style="font-size: 16px; margin-right: 6px; width: 18px; text-align: center;"></i>`;
                        } else if (subcat.icon && !subcat.icon.includes('fa-')) {
                            subIconHtml = `<span style="font-size: 16px; margin-right: 6px;">${subcat.icon}</span>`;
                        } else {
                            subIconHtml = `<span style="font-size: 16px; margin-right: 6px;">‚îî</span>`;
                        }
                        
                        categoryHtml += `
                            <div class="spending-item subcategory-item">
                                <div class="input-group">
                                    <span class="input-group-text" style="min-width: 140px; background: #f8f9fa; font-size: 13px;">
                                        ${subIconHtml}${subDisplayName} ${subTooltipHtml}
                                    </span>
                                    <span class="input-group-text">$</span>
                                    <input type="number" id="${subHtmlId}" data-category-slug="${subSlug}" 
                                           placeholder="0" min="0" step="10" class="form-control spending-input">
                                </div>
                            </div>
                        `;
                    });
                }
                
                return categoryHtml;
            }).join('');
            
            container.innerHTML = html;
        }

        function renderCreditTypes(categorizedCredits) {
            const container = document.getElementById('creditTypes');
            
            // Flatten all credit types into a single list
            const allCredits = [];
            Object.values(categorizedCredits).forEach(categoryCredits => {
                allCredits.push(...categoryCredits);
            });
            
            // Sort alphabetically by name
            allCredits.sort((a, b) => a.name.localeCompare(b.name));
            
            let html = '<div class="credits-checkbox-list">';
            
            allCredits.forEach(creditType => {
                const tooltipHtml = creditType.description ? 
                    `title="${creditType.description}"` : '';
                
                html += `
                    <div class="credit-checkbox-item">
                        <input type="checkbox" id="credit_${creditType.slug}" name="credit_preferences" 
                               value="${creditType.slug}" onchange="handleCreditChange(this)">
                        <label for="credit_${creditType.slug}" ${tooltipHtml}>
                            ${creditType.icon ? `${creditType.icon} ` : ''}${creditType.name}
                        </label>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function handleCreditChange(checkbox) {
            // Save credit preferences
            saveCreditPreferences();
        }

        function setupTotalCalculation() {
            // Update total whenever any spending input changes
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('spending-input')) {
                    updateTotal();
                }
            });
            
            // Initial calculation
            updateTotal();
        }

        function updateTotal() {
            const spendingInputs = document.querySelectorAll('.spending-input');
            let total = 0;
            
            spendingInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            document.getElementById('totalSpending').textContent = total.toLocaleString();
        }

        function resetSpendingProfile() {
            if (confirm('Are you sure you want to reset all spending amounts and credit preferences? This action cannot be undone.')) {
                // Clear all spending inputs
                const spendingInputs = document.querySelectorAll('.spending-input');
                spendingInputs.forEach(input => {
                    input.value = '';
                });
                
                // Clear all credit preference checkboxes
                const creditCheckboxes = document.querySelectorAll('input[name="credit_preferences"]');
                creditCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Update the total display
                updateTotal();
                
                // Clear saved data
                clearSavedData();
                
                // Show success message
                const totalSection = document.getElementById('totalSpending').parentElement;
                const originalBg = totalSection.style.background;
                totalSection.style.background = '#d1fae5';
                setTimeout(() => {
                    totalSection.style.background = originalBg;
                }, 2000);
                
                console.log('Spending profile and credit preferences have been reset');
            }
        }

        async function clearSavedData() {
            try {
                // Clear spending data
                await UserDataManager.saveSpending({});
                
                // Clear credit preferences from localStorage
                localStorage.removeItem('userCreditPreferences');
                
                console.log('Saved data cleared successfully');
            } catch (error) {
                console.error('Error clearing saved data:', error);
            }
        }

        async function loadSavedData() {
            try {
                // Wait for user state to be initialized
                await initUserState();
                
                // Load spending data
                const savedSpending = await UserDataManager.getSpending();
                Object.keys(savedSpending).forEach(categorySlug => {
                    const amount = savedSpending[categorySlug];
                    // Convert slug to HTML ID (replace hyphens with underscores)
                    const htmlId = categorySlug.replace(/-/g, '_');
                    const input = document.getElementById(htmlId);
                    if (input && amount) {
                        input.value = amount;
                    }
                });
                
                // Update total after loading saved data
                updateTotal();
                
                // Load preferences
                const savedPreferences = await UserDataManager.getPreferences();
                if (savedPreferences.default_issuer_filter) {
                    const issuerSelect = document.getElementById('issuer');
                    if (issuerSelect) issuerSelect.value = savedPreferences.default_issuer_filter;
                }
                if (savedPreferences.default_reward_type_filter) {
                    const rewardTypeSelect = document.getElementById('rewardType');
                    if (rewardTypeSelect) rewardTypeSelect.value = savedPreferences.default_reward_type_filter;
                }
                if (savedPreferences.default_max_fee_filter) {
                    const maxFeeInput = document.getElementById('maxFee');
                    if (maxFeeInput) maxFeeInput.value = savedPreferences.default_max_fee_filter;
                }
                if (savedPreferences.default_max_recommendations) {
                    const maxRecsSelect = document.getElementById('maxRecs');
                    if (maxRecsSelect) maxRecsSelect.value = savedPreferences.default_max_recommendations;
                }
                
                // Load credit preferences after a short delay to ensure credit types are rendered
                setTimeout(() => {
                    loadCreditPreferences();
                }, 500);
            } catch (error) {
                console.error('Error loading saved data:', error);
            }
        }

        async function saveCreditPreferences() {
            try {
                const selectedCredits = [];
                const creditCheckboxes = document.querySelectorAll('input[name="credit_preferences"]:checked');
                creditCheckboxes.forEach(checkbox => {
                    selectedCredits.push(checkbox.value);
                });
                
                // Save to localStorage for immediate persistence
                localStorage.setItem('userCreditPreferences', JSON.stringify(selectedCredits));
                
                // TODO: Save to server for authenticated users
                console.log('Credit preferences saved:', selectedCredits);
                
            } catch (error) {
                console.error('Error saving credit preferences:', error);
            }
        }

        async function loadCreditPreferences() {
            try {
                // Load from localStorage
                const savedCredits = JSON.parse(localStorage.getItem('userCreditPreferences') || '[]');
                
                // Apply saved preferences
                savedCredits.forEach(creditSlug => {
                    const checkbox = document.querySelector(`input[value="${creditSlug}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                
            } catch (error) {
                console.error('Error loading credit preferences:', error);
            }
        }

        async function saveCurrentData() {
            try {
                // Save spending data
                const spendingData = {};
                const spendingInputs = document.querySelectorAll('.spending-input');
                spendingInputs.forEach(input => {
                    const categorySlug = input.dataset.categorySlug;
                    const value = input.value;
                    if (value && categorySlug) {
                        spendingData[categorySlug] = parseFloat(value) || 0;
                    }
                });
                
                // Save preferences
                const preferencesData = {
                    default_issuer_filter: document.getElementById('issuer')?.value || '',
                    default_reward_type_filter: document.getElementById('rewardType')?.value || '',
                    default_max_fee_filter: parseFloat(document.getElementById('maxFee')?.value) || null,
                    default_max_recommendations: parseInt(document.getElementById('maxRecs')?.value) || 5
                };
                
                // Use the unified data manager to save
                await UserDataManager.saveSpending(spendingData);
                
                // Save credit preferences
                await saveCreditPreferences();
                
                // For preferences, we need to save them separately since UserDataManager 
                // doesn't have a savePreferences method yet
                if (isAuthenticated) {
                    try {
                        await fetch(`${API_BASE}/users/data/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                spending: spendingData,
                                cards: await UserDataManager.getCards(),
                                preferences: preferencesData
                            })
                        });
                    } catch (error) {
                        console.error('Error saving to server:', error);
                    }
                } else {
                    // Save preferences to localStorage for anonymous users
                    localStorage.setItem('userPreferences', JSON.stringify(preferencesData));
                }
                
            } catch (error) {
                console.error('Error saving current data:', error);
            }
        }

        async function getRecommendations() {
            // Collapse preferences section
            const preferencesContent = document.getElementById('preferencesContent');
            const preferencesToggle = document.getElementById('preferencesToggle');
            if (preferencesContent.style.display !== 'none') {
                preferencesContent.style.display = 'none';
                preferencesToggle.textContent = '‚ñº Click to expand';
            }
            
            // Save current data before getting recommendations
            await saveCurrentData();
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">üîÑ Analyzing your profile and generating recommendations...</div>';

            try {
                // Build spending amounts object
                const spendingAmounts = {};
                
                // Build spending amounts from dynamic inputs
                const spendingInputs = document.querySelectorAll('.spending-input');
                spendingInputs.forEach(input => {
                    const categorySlug = input.dataset.categorySlug;
                    const amount = input.value;
                    const categoryId = spendingCategories[categorySlug];
                    
                    if (amount && amount > 0 && categoryId) {
                        spendingAmounts[categoryId] = parseFloat(amount);
                    }
                });

                // Build user cards array from saved data
                const userCardIds = await UserDataManager.getCards();
                const userCards = userCardIds.map(cardId => ({
                    card_id: cardId,
                    opened_date: '2023-01-01', // Default date
                    nickname: '',
                    is_active: true
                }));

                // Build filters array
                const filters = [];
                const cardType = document.getElementById('cardType').value;
                const issuer = document.getElementById('issuer').value;
                const rewardType = document.getElementById('rewardType').value;
                const maxFee = document.getElementById('maxFee').value;

                if (cardType && cardType !== 'all') {
                    filters.push({
                        name: 'Card Type Filter',
                        filter_type: 'card_type',
                        value: cardType
                    });
                }
                if (issuer) {
                    filters.push({
                        name: 'Issuer Filter',
                        filter_type: 'issuer',
                        value: issuer
                    });
                }
                if (rewardType) {
                    filters.push({
                        name: 'Reward Type Filter',
                        filter_type: 'reward_type',
                        value: rewardType
                    });
                }
                if (maxFee) {
                    filters.push({
                        name: 'Annual Fee Filter',
                        filter_type: 'annual_fee',
                        value: `0-${maxFee}`
                    });
                }

                // Get selected credit preferences
                const selectedCredits = [];
                const creditCheckboxes = document.querySelectorAll('input[name="credit_preferences"]:checked');
                creditCheckboxes.forEach(checkbox => {
                    selectedCredits.push(checkbox.value);
                });

                const requestData = {
                    spending_amounts: spendingAmounts,
                    user_cards: userCards,
                    filters: filters,
                    max_recommendations: parseInt(document.getElementById('maxRecs').value),
                    credit_preferences: selectedCredits
                };

                const response = await fetch(`${API_BASE}/roadmaps/quick-recommendation/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                    return;
                }

                // Display recommendations
                const recommendations = data.recommendations || [];
                const portfolioSummary = data.portfolio_summary || {};

                let html = `
                    <div class="results">
                        <h2>üéØ Your Personalized Credit Card Roadmap</h2>
                `;

                // Add portfolio summary if we have recommendations
                if (recommendations.length > 0 && portfolioSummary.card_count > 0) {
                    const categoryOptimization = portfolioSummary.category_optimization || {};
                    const categoryOptimizationEntries = Object.entries(categoryOptimization);
                    
                    html += `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                            <h3 style="margin: 0 0 15px 0; color: white;">üìä Portfolio Summary</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">$${portfolioSummary.total_annual_fees.toFixed(0)}</div>
                                    <div style="opacity: 0.9; font-size: 14px;">Total Annual Fees</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">$${portfolioSummary.total_portfolio_rewards.toFixed(0)}</div>
                                    <div style="opacity: 0.9; font-size: 14px;">Total Portfolio Rewards</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: ${portfolioSummary.net_portfolio_value >= 0 ? '#10b981' : '#ef4444'};">$${portfolioSummary.net_portfolio_value.toFixed(0)}</div>
                                    <div style="opacity: 0.9; font-size: 14px;">Net Portfolio Value</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${portfolioSummary.card_count}</div>
                                    <div style="opacity: 0.9; font-size: 14px;">Recommended Cards</div>
                                </div>
                            </div>
                            ${categoryOptimizationEntries.length > 0 ? `
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">üéØ Optimized Reward Rates by Category</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                                        ${categoryOptimizationEntries.map(([slug, data]) => `
                                            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 6px;">
                                                <div>
                                                    <div style="font-weight: 600; font-size: 14px;">${data.category_name}</div>
                                                    <div style="opacity: 0.8; font-size: 12px;">${data.best_card}</div>
                                                </div>
                                                <div style="font-weight: bold; font-size: 16px;">${data.best_rate}x</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                if (recommendations.length === 0) {
                    html += '<p>No recommendations found with your current criteria. Try adjusting your filters.</p>';
                } else {
                    recommendations.forEach((rec, index) => {
                        const actionClass = rec.action.toLowerCase();
                        const actionEmoji = {
                            'apply': '‚úÖ',
                            'keep': 'üëç',
                            'cancel': '‚ùå',
                            'upgrade': '‚¨ÜÔ∏è',
                            'downgrade': '‚¨áÔ∏è'
                        }[rec.action] || 'üìã';

                        // Generate rewards breakdown HTML
                        let breakdownHtml = '';
                        
                        if (rec.rewards_breakdown && Array.isArray(rec.rewards_breakdown) && rec.rewards_breakdown.length > 0) {
                            breakdownHtml = '<div style="margin-top: 15px; background: #f8f9fa; padding: 10px; border-radius: 6px;"><strong>üí∞ Rewards Breakdown:</strong><ul style="margin: 8px 0; padding-left: 20px;">';
                            rec.rewards_breakdown.forEach(breakdown => {
                                const categoryName = breakdown.category_name || 'Unknown Category';
                                const calculation = breakdown.calculation || 'No calculation available';
                                breakdownHtml += `<li style="margin: 4px 0; font-family: monospace; font-size: 14px; color: #2563eb;"><strong>${categoryName}:</strong> ${calculation}</li>`;
                            });
                            breakdownHtml += '</ul></div>';
                        }

                        html += `
                            <div class="recommendation ${actionClass} modal-card-clickable" onclick="openCardModal(${rec.card.id})">
                                <div style="display: flex; justify-content: between; align-items: start;">
                                    <div>
                                        <h3>${actionEmoji} ${rec.action.toUpperCase()}: ${rec.card.name}</h3>
                                        <p><strong>Estimated Value:</strong> $${rec.estimated_rewards.toFixed(0)}</p>
                                        <p><strong>Annual Fee:</strong> $${rec.card.effective_annual_fee}${rec.card.annual_fee_waived_first_year && rec.action === 'apply' ? ' (first year waived)' : ''}</p>
                                        ${rec.card.signup_bonus_amount && rec.action === 'apply' ? 
                                            `<p><strong>Signup Bonus:</strong> ${rec.card.signup_bonus_amount} points/miles</p>` : ''
                                        }
                                        ${breakdownHtml}
                                        <p><strong>Why:</strong> ${rec.reasoning}</p>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="background: rgba(255,255,255,0.7); padding: 8px 12px; border-radius: 20px; font-weight: 600; text-align: center;">
                                            #${rec.priority}
                                        </div>
                                        ${rec.action === 'apply' ? 
                                            `<button onclick="event.stopPropagation(); toggleCardOwnership(${rec.card.id}, this)" style="padding: 6px 12px; font-size: 12px; background: #10b981;">
                                                ‚úÖ I have this card
                                            </button>` : ''
                                        }
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                html += '</div>';
                resultsDiv.innerHTML = html;
                
                // Apply mobile classes after rendering results
                applyMobileClasses();

            } catch (error) {
                resultsDiv.innerHTML = '<div class="error">Error generating recommendations. Please try again.</div>';
                console.error('Error:', error);
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Apply mobile-specific classes based on screen size
        function applyMobileClasses() {
            const isMobile = window.innerWidth <= 480;
            const preferencesSection = document.querySelector('.preferences-section');
            const spendingSection = document.querySelector('.spending-section');
            const actionButton = document.querySelector('.action-button');
            const resultsSection = document.querySelector('.results');
            
            if (isMobile) {
                preferencesSection?.classList.add('preferences-mobile');
                spendingSection?.classList.add('spending-mobile');
                actionButton?.classList.add('action-button-mobile');
                resultsSection?.classList.add('results-mobile');
            } else {
                preferencesSection?.classList.remove('preferences-mobile');
                spendingSection?.classList.remove('spending-mobile');
                actionButton?.classList.remove('action-button-mobile');
                resultsSection?.classList.remove('results-mobile');
            }
        }
        
        // Apply mobile classes on load and resize
        window.addEventListener('load', applyMobileClasses);
        window.addEventListener('resize', applyMobileClasses);
        
        // Load initial data when page loads
        loadData();
        
        // Auto-save when user navigates away
        window.addEventListener('beforeunload', function(e) {
            // Save data synchronously (limited time available)
            try {
                const spendingData = {};
                const spendingInputs = document.querySelectorAll('.spending-input');
                spendingInputs.forEach(input => {
                    const categorySlug = input.dataset.categorySlug;
                    const value = input.value;
                    if (value && categorySlug) {
                        spendingData[categorySlug] = parseFloat(value) || 0;
                    }
                });
                
                const preferencesData = {
                    default_issuer_filter: document.getElementById('issuer')?.value || '',
                    default_reward_type_filter: document.getElementById('rewardType')?.value || '',
                    default_max_fee_filter: parseFloat(document.getElementById('maxFee')?.value) || null,
                    default_max_recommendations: parseInt(document.getElementById('maxRecs')?.value) || 5
                };
                
                // Use localStorage for immediate saving (works in beforeunload)
                localStorage.setItem('userSpending', JSON.stringify(spendingData));
                localStorage.setItem('userPreferences', JSON.stringify(preferencesData));
                
                // If authenticated, try to save to server (may not complete)
                if (isAuthenticated) {
                    navigator.sendBeacon(`${API_BASE}/users/data/`, JSON.stringify({
                        spending: spendingData,
                        cards: JSON.parse(localStorage.getItem('userCards') || '[]'),
                        preferences: preferencesData
                    }));
                }
            } catch (error) {
                console.error('Error in beforeunload save:', error);
            }
        });
        
        // Auto-save on form changes (debounced)
        let saveTimeout;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveCurrentData, 1000); // Save 1 second after last change
        }
        
        function setupAutoSave() {
            // Add listeners to all spending inputs (dynamic)
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('spending-input')) {
                    debouncedSave();
                }
            });
            
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('spending-input')) {
                    debouncedSave();
                }
            });
            
            // Add listeners to preference inputs
            const preferenceInputs = ['issuer', 'rewardType', 'maxFee', 'maxRecs'];
            preferenceInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('change', debouncedSave);
                }
            });
        }
        
        // Card ownership functions for roadmap page
        async function toggleCardOwnership(cardId, button) {
            try {
                button.disabled = true;
                button.textContent = '...';
                
                // Show nickname/opening date popup
                const cardDetails = await showCardDetailsPopupRoadmap(cardId);
                if (cardDetails === null) {
                    // User cancelled
                    button.disabled = false;
                    button.textContent = '‚úÖ I have this card';
                    return;
                }
                
                // Add card with details
                const success = await UserDataManager.addCardWithDetails(cardId, cardDetails.nickname, cardDetails.openingDate);
                if (success) {
                    button.textContent = '‚úÖ Added!';
                    button.disabled = true;
                    alert(`Added ${cardDetails.nickname} to your collection!`);
                } else {
                    throw new Error('Failed to add card');
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding card');
                button.disabled = false;
                button.textContent = '‚úÖ I have this card';
            }
        }
        
        function showCardDetailsPopupRoadmap(cardId) {
            return new Promise((resolve) => {
                // Clean up any existing modal first
                const existingModal = document.getElementById('cardDetailsModalRoadmap');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Create modal HTML  
                const modalHtml = `
                    <div id="cardDetailsModalRoadmap" class="modal" style="display: block;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>Add Card to Your Collection</h2>
                                <span class="close" onclick="closeCardDetailsPopupRoadmap()">&times;</span>
                            </div>
                            <div class="modal-body">
                                <form id="cardDetailsFormRoadmap">
                                    <div class="form-group">
                                        <label for="cardNicknameRoadmap">Nickname (required):</label>
                                        <input type="text" id="cardNicknameRoadmap" name="nickname" 
                                               placeholder="e.g., My Travel Card, Personal Card, etc." 
                                               required maxlength="100">
                                    </div>
                                    <div class="form-group">
                                        <label for="cardOpeningDateRoadmap">Opening Date (optional):</label>
                                        <input type="date" id="cardOpeningDateRoadmap" name="openingDate">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn secondary" onclick="closeCardDetailsPopupRoadmap()">Cancel</button>
                                <button type="button" class="btn primary" onclick="saveCardDetailsPopupRoadmap()">Add Card</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Store resolve function for callbacks first
                window.cardDetailsResolveRoadmap = resolve;
                
                // Focus on nickname input with delay
                setTimeout(() => {
                    const nicknameInput = document.getElementById('cardNicknameRoadmap');
                    if (nicknameInput) {
                        nicknameInput.focus();
                    }
                }, 100);
            });
        }

        function closeCardDetailsPopupRoadmap() {
            const modal = document.getElementById('cardDetailsModalRoadmap');
            if (modal) {
                modal.remove();
            }
            if (window.cardDetailsResolveRoadmap) {
                window.cardDetailsResolveRoadmap(null); // Return null for cancelled
            }
        }

        function saveCardDetailsPopupRoadmap() {
            // Use multiple fallback methods to ensure we get the input value
            const nicknameInput = document.getElementById('cardNicknameRoadmap') || document.querySelector('#cardNicknameRoadmap') || document.querySelector('input[name="nickname"]');
            const openingDateInput = document.getElementById('cardOpeningDateRoadmap');
            
            if (!nicknameInput) {
                alert('Error: Could not find nickname input field');
                return;
            }
            
            const nickname = (nicknameInput.value || '').trim();
            const openingDate = openingDateInput ? openingDateInput.value : '';
            
            if (!nickname) {
                alert('Please enter a nickname for this card');
                nicknameInput.focus();
                return;
            }
            
            // Store the values before removing modal
            const cardDetails = {
                nickname: nickname,
                openingDate: openingDate || null
            };
            
            // Remove modal
            const modal = document.getElementById('cardDetailsModalRoadmap');
            if (modal) {
                modal.remove();
            }
            
            // Resolve with the stored values
            if (window.cardDetailsResolveRoadmap) {
                window.cardDetailsResolveRoadmap(cardDetails);
            }
        }
        
    </script>
{% endblock %}

{% block extra_js %}{% endblock %}