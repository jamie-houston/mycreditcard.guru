{% extends 'base.html' %}

{% block title %}My Profile - Credit Card Guru{% endblock %}

{% block extra_css %}
<style>
.toggle-switch {
    display: flex;
    background: #f3f4f6;
    border-radius: 8px;
    padding: 4px;
    position: relative;
}

.toggle-switch input[type="radio"] {
    display: none;
}

.toggle-option {
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    font-weight: 500;
    color: #6b7280;
    user-select: none;
}

.toggle-switch input[type="radio"]:checked + .toggle-option {
    background: white;
    color: #1f2937;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.toggle-option:hover {
    color: #374151;
}

.privacy-toggle-section {
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .privacy-toggle-section {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    #shareable-url-section {
        margin-left: 0 !important;
    }
    
    #shareable-url {
        width: 200px !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1>My Credit Card Profile</h1>
    
    <!-- Privacy Toggle Section -->
    <div class="privacy-toggle-section" style="display: flex; align-items: center; gap: 15px;">
        <label style="color: #6b7280; font-weight: 500;">Profile Visibility:</label>
        
        <div class="toggle-switch">
            <input type="radio" id="privacy-private" name="privacy" value="private" checked>
            <label for="privacy-private" class="toggle-option">
                üîí Private
            </label>
            
            <input type="radio" id="privacy-public" name="privacy" value="public">
            <label for="privacy-public" class="toggle-option">
                üåê Public
            </label>
        </div>
        
        <!-- Shareable URL Section (hidden by default) -->
        <div id="shareable-url-section" style="display: none; margin-left: 15px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <label style="color: #6b7280; font-size: 14px;">Share URL:</label>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="text" id="shareable-url" readonly 
                           style="background: #f9fafb; border: 1px solid #d1d5db; padding: 5px 8px; border-radius: 6px; font-size: 12px; width: 300px;"
                           placeholder="Generating shareable URL...">
                    <button id="copy-url-btn" onclick="copyShareableUrl()" 
                            style="background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                        üìã Copy
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Optimization Section -->
<div class="section">
    <h2>üéØ Which Card to Use for Each Category</h2>
    <p style="color: #6b7280; margin-bottom: 20px;">Here's which card to use for each category to maximize rewards based on your card collection:</p>
    <div id="categoryOptimization">
        <div class="loading">Loading category recommendations...</div>
    </div>
    
    <!-- Add Card Input - Always Visible -->
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <h3 style="margin-bottom: 15px; color: #374151; font-size: 16px;">‚ûï Add Credit Cards</h3>
        <p style="color: #6b7280; margin-bottom: 15px; font-size: 14px;">Add cards to your collection to see updated recommendations:</p>
        
        <div style="margin-bottom: 20px;">
            <!-- Searchable Card Dropdown -->
            <div style="position: relative;">
                <label for="cardSearch" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Search for a card:</label>
                <input 
                    type="text" 
                    id="cardSearch" 
                    placeholder="Type card name (e.g., 'Chase Sapphire', 'Blue Cash')..." 
                    autocomplete="off"
                    style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s; box-sizing: border-box;"
                >
                <!-- Dropdown will be moved to body dynamically -->
                <div id="cardSearchResults" style="display: none;">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profile Summary Section -->
<div class="section">
    <h2>üìä Portfolio Summary</h2>
    <div class="modal-info-grid">
        <div class="modal-info-item">
            <div class="modal-info-label">Total Cards</div>
            <div class="modal-info-value" id="totalCards">Loading...</div>
        </div>
        <div class="modal-info-item">
            <div class="modal-info-label">Total Annual Fees</div>
            <div class="modal-info-value" id="totalAnnualFees">Loading...</div>
        </div>
        <div class="modal-info-item">
            <div class="modal-info-label">Estimated Annual Rewards</div>
            <div class="modal-info-value" id="totalAnnualRewards">Loading...</div>
        </div>
        <div class="modal-info-item">
            <div class="modal-info-label">Net Portfolio Value</div>
            <div class="modal-info-value" id="netPortfolioValue">Loading...</div>
        </div>
    </div>
</div>


<!-- Card Collection Section -->
<div class="section">
    <h2>üí≥ My Card Collection</h2>
    <div id="cardCollection">
        <div class="loading">Loading your card collection...</div>
    </div>
</div>

<!-- Spending Profile Section -->
<div class="section">
    <h2>üìà Your Spending Profile</h2>
    <div id="spendingProfile">
        <div class="loading">Loading spending profile...</div>
    </div>
</div>

<!-- Credits & Benefits Section -->
<div class="section">
    <h2>üéÅ Your Card Credits & Benefits</h2>
    <div id="creditsProfile">
        <div class="loading">Loading your benefits...</div>
    </div>
</div>

<style>
.profile-card {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.profile-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.card-name {
    font-size: 18px;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
}

.card-nickname {
    font-size: 14px;
    color: #6b7280;
    margin: 2px 0 0 0;
}

.card-fee {
    font-size: 16px;
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 8px;
    margin-left: 10px;
}

.fee-zero {
    background: #dcfce7;
    color: #166534;
}

.fee-paid {
    background: #fef3c7;
    color: #92400e;
}

.card-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.detail-item {
    background: #f8fafc;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.detail-label {
    font-size: 12px;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.detail-value {
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
}

.category-optimization-simple {
    background: linear-gradient(135deg, rgba(239, 246, 255, 0.9) 0%, rgba(239, 246, 255, 0.7) 100%);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.category-simple-name {
    font-size: 16px;
    font-weight: 600;
    color: #1e40af;
    min-width: 120px;
    flex-shrink: 0;
}

.rate-simple {
    background: #10b981;
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 700;
    min-width: 50px;
    text-align: center;
    flex-shrink: 0;
}

.card-simple-name {
    font-size: 15px;
    font-weight: 600;
    color: #1f2937;
    flex: 1;
}

.spending-cap-simple {
    font-size: 12px;
    color: #64748b;
    font-style: italic;
    margin-left: auto;
    flex-shrink: 0;
}

/* Card Table Styles */
.card-table-container {
    overflow-x: auto;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    background: white;
    border: 1px solid #e5e7eb;
}

.cards-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.cards-table th {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    color: #374151;
    font-weight: 600;
    text-align: left;
    padding: 16px 12px;
    border-bottom: 2px solid #e5e7eb;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.cards-table td {
    padding: 16px 12px;
    border-bottom: 1px solid #f3f4f6;
    vertical-align: top;
}

.card-row {
    transition: all 0.2s ease;
    cursor: pointer;
}

.card-row:hover {
    background-color: #f8fafc;
    transform: scale(1.01);
}

.card-row:last-child td {
    border-bottom: none;
}

.card-name-cell {
    max-width: 250px;
}

.card-name-wrapper strong {
    color: #1f2937;
    font-weight: 600;
    display: block;
    margin-bottom: 2px;
}

.card-nicknames {
    color: #6b7280;
    font-style: italic;
    font-size: 12px;
}

.card-count-cell {
    text-align: center;
    white-space: nowrap;
}

.card-count {
    background: #e0f2fe;
    color: #0891b2;
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 12px;
}

.multiple-indicator {
    margin-left: 4px;
    opacity: 0.7;
}

.actions-cell {
    text-align: center;
    width: 60px;
}

.table-action-btn {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 6px 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
}

.table-action-btn:hover {
    background: #e5e7eb;
    transform: scale(1.1);
}

/* Fee styling in table */
.cards-table .fee-zero {
    background: #dcfce7;
    color: #166534;
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 12px;
}

.cards-table .fee-paid {
    background: #fef3c7;
    color: #92400e;
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 12px;
}

/* Responsive table */
@media (max-width: 768px) {
    .card-table-container {
        font-size: 12px;
    }
    
    .cards-table th,
    .cards-table td {
        padding: 8px 6px;
    }
    
    .card-name-cell {
        max-width: 150px;
    }
}

/* Legacy styles for backward compatibility */
.category-optimization-item {
    background: linear-gradient(135deg, rgba(239, 246, 255, 0.9) 0%, rgba(239, 246, 255, 0.7) 100%);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.category-info {
    flex: 1;
}

.category-name {
    font-size: 16px;
    font-weight: 600;
    color: #1e40af;
    margin-bottom: 4px;
}

.category-details {
    font-size: 14px;
    color: #64748b;
}

.category-recommendation {
    text-align: right;
    padding-left: 20px;
}

.recommended-card {
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 4px;
}

.reward-rate {
    background: #10b981;
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
}

.spending-item {
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(229, 231, 235, 0.6);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.spending-category {
    font-size: 16px;
    font-weight: 600;
    color: #374151;
}

.spending-amounts {
    text-align: right;
}

.monthly-amount {
    font-size: 18px;
    font-weight: 700;
    color: #059669;
    margin-bottom: 2px;
}

.annual-amount {
    font-size: 14px;
    color: #6b7280;
}

.no-data {
    text-align: center;
    color: #6b7280;
    padding: 40px 20px;
    font-style: italic;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6b7280;
}

.empty-state h3 {
    color: #374151;
    margin-bottom: 8px;
}

.empty-state p {
    margin-bottom: 20px;
}

.empty-state a {
    display: inline-block;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: transform 0.2s;
}

.empty-state a:hover {
    transform: translateY(-2px);
}

@media (max-width: 768px) {
    .card-details {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .category-optimization-simple {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .category-simple-name {
        min-width: auto;
    }
    
    .rate-simple {
        min-width: auto;
        align-self: flex-start;
    }
    
    .spending-cap-simple {
        margin-left: 0;
        align-self: flex-start;
    }
    
    .category-optimization-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .category-recommendation {
        text-align: left;
        padding-left: 0;
    }
    
    .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .card-fee {
        margin-left: 0;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    await loadProfileData();
    
    // Set up card search event listeners
    const cardSearchInput = document.getElementById('cardSearch');
    if (cardSearchInput) {
        cardSearchInput.addEventListener('input', function(e) {
            searchCards(e.target.value);
        });
        
        cardSearchInput.addEventListener('focus', function(e) {
            e.target.style.borderColor = '#3b82f6';
        });
        
        cardSearchInput.addEventListener('blur', function(e) {
            if (!e.target.value) {
                e.target.style.borderColor = '#e5e7eb';
            }
            setTimeout(() => hideSearchResults(), 200);
        });
    }
});

async function loadProfileData() {
    try {
        // Initialize user state first
        await initUserState();
        
        // Update UI based on authentication status
        updateAddCardSection();
        
        // Load all profile data
        await Promise.all([
            loadCardCollection(),
            loadCategoryOptimization(),
            loadSpendingProfile(),
            loadCreditsProfile()
        ]);

        // Calculate and display portfolio summary
        calculatePortfolioSummary();
        
    } catch (error) {
        console.error('Error loading profile data:', error);
        showError('Failed to load profile data. Please try refreshing the page.');
    }
}

async function loadCardCollection() {
    try {
        let userCardsDetails;
        const cardCollectionContainer = document.getElementById('cardCollection');
        
        if (!isAuthenticated) {
            // For unauthenticated users, get cards from local storage
            const localCardIds = LocalStorage.getCards();
            const localCardDetails = LocalStorage.getCardDetails();
            
            if (localCardIds.length === 0) {
                cardCollectionContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>No Cards Added Yet</h3>
                        <p>Start building your credit card portfolio by adding your cards using the search above. Your cards will be saved locally, and you can sync them to your account when you log in.</p>
                        <a href="/cards/">Browse All Credit Cards</a>
                    </div>
                `;
                return;
            }
            
            // Convert local storage data to match expected format
            userCardsDetails = [];
            for (const cardId of localCardIds) {
                try {
                    const response = await fetch(`${API_BASE}/cards/cards/${cardId}/`);
                    if (response.ok) {
                        const cardData = await response.json();
                        const details = localCardDetails[cardId] || {};
                        userCardsDetails.push({
                            id: `local_${cardId}`,
                            card: cardData,
                            nickname: details.nickname || '',
                            opened_date: details.opened_date || null,
                            closed_date: null,
                            notes: details.notes || '',
                            is_local: true
                        });
                    }
                } catch (error) {
                    console.error(`Error fetching card ${cardId}:`, error);
                }
            }
        } else {
            // For authenticated users, get from server
            userCardsDetails = await UserDataManager.getUserCardsDetails();
        }
        
        if (!userCardsDetails || userCardsDetails.length === 0) {
            cardCollectionContainer.innerHTML = `
                <div class="empty-state">
                    <h3>No Cards Added Yet</h3>
                    <p>Start building your credit card portfolio by adding your cards using the search above.</p>
                    <a href="/cards/">Browse All Credit Cards</a>
                </div>
            `;
            return;
        }
        
        // Group cards by card ID and count duplicates
        const cardGroups = {};
        for (const userCard of userCardsDetails) {
            const cardId = userCard.card.id;
            if (!cardGroups[cardId]) {
                cardGroups[cardId] = {
                    card: userCard.card,
                    instances: []
                };
            }
            cardGroups[cardId].instances.push(userCard);
        }
        
        // Fetch detailed card information
        const cardIds = Object.keys(cardGroups);
        const cardDetails = {};
        
        for (const cardId of cardIds) {
            try {
                const response = await fetch(`${API_BASE}/cards/cards/${cardId}/`);
                if (response.ok) {
                    cardDetails[cardId] = await response.json();
                }
            } catch (error) {
                console.error(`Error fetching details for card ${cardId}:`, error);
            }
        }
        
        // Create table structure
        let cardsHtml = `
            <div class="card-table-container">
                <table class="cards-table">
                    <thead>
                        <tr>
                            <th>Card Name</th>
                            <th>Issuer</th>
                            <th>Annual Fee</th>
                            <th>Reward Type</th>
                            <th>Point Value</th>
                            <th>Signup Bonus</th>
                            <th>Card Type</th>
                            <th>Count</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (const [cardId, group] of Object.entries(cardGroups)) {
            const cardInfo = cardDetails[cardId];
            if (!cardInfo) continue;
            
            const instances = group.instances;
            const hasMultiple = instances.length > 1;
            
            // Calculate annual fee
            const annualFee = parseFloat(cardInfo.annual_fee || 0);
            const feeClass = annualFee === 0 ? 'fee-zero' : 'fee-paid';
            const feeText = annualFee === 0 ? 'No Fee' : `$${annualFee}/year`;
            
            // Get reward type and value
            const rewardType = cardInfo.primary_reward_type?.name || 'Unknown';
            const rewardMultiplier = cardInfo.metadata?.reward_value_multiplier || 0.01;
            const pointValue = `${(rewardMultiplier * 100).toFixed(1)}¬¢`;
            
            // Get signup bonus
            const signupBonus = cardInfo.signup_bonus_amount ? 
                `${cardInfo.signup_bonus_amount.toLocaleString()} ${rewardType}` : 'None';
            
            // Create nicknames display for table
            let nicknamesDisplay = '';
            if (hasMultiple) {
                const nicknames = instances.filter(i => i.nickname).map(i => i.nickname);
                nicknamesDisplay = nicknames.length > 0 ? 
                    `<small class="card-nicknames">${nicknames.join(', ')}</small>` : '';
            } else {
                const instance = instances[0];
                nicknamesDisplay = instance.nickname ? 
                    `<small class="card-nicknames">${instance.nickname}</small>` : '';
            }
            
            cardsHtml += `
                <tr class="card-row modal-card-clickable" onclick="openCardModal(${cardId})" title="Click to view details">
                    <td class="card-name-cell">
                        <div class="card-name-wrapper">
                            <strong>${cardInfo.name}</strong>
                            ${nicknamesDisplay ? `<br>${nicknamesDisplay}` : ''}
                        </div>
                    </td>
                    <td>${cardInfo.issuer?.name || 'Unknown'}</td>
                    <td><span class="${feeClass}">${feeText}</span></td>
                    <td>${rewardType}</td>
                    <td>${pointValue}</td>
                    <td>${signupBonus}</td>
                    <td>${cardInfo.card_type ? cardInfo.card_type.charAt(0).toUpperCase() + cardInfo.card_type.slice(1) : 'Personal'}</td>
                    <td class="card-count-cell">
                        <span class="card-count">${instances.length}</span>
                        ${hasMultiple ? ' <span class="multiple-indicator" title="Multiple cards">üìö</span>' : ''}
                    </td>
                    <td class="actions-cell">
                        <button class="table-action-btn" onclick="event.stopPropagation(); openCardModal(${cardId})" title="View Details">
                            üëÅÔ∏è
                        </button>
                    </td>
                </tr>
            `;
        }
        
        cardsHtml += `
                    </tbody>
                </table>
            </div>
        `;
        
        cardCollectionContainer.innerHTML = cardsHtml;
        
    } catch (error) {
        console.error('Error loading card collection:', error);
        document.getElementById('cardCollection').innerHTML = `
            <div class="error">Error loading card collection. Please try refreshing the page.</div>
        `;
    }
}

async function loadCategoryOptimization() {
    try {
        const userCards = await UserDataManager.getCards();
        const categoryContainer = document.getElementById('categoryOptimization');
        
        if (!userCards || userCards.length === 0) {
            categoryContainer.innerHTML = `
                <div class="empty-state">
                    <h3>Add Cards to See Categories</h3>
                    <p>Add your credit cards using the search box below to see which card to use for each spending category.</p>
                </div>
            `;
            return;
        }
        
        // Get detailed card information for all user cards
        const cardDetails = {};
        for (const cardId of userCards) {
            try {
                const response = await fetch(`${API_BASE}/cards/cards/${cardId}/`);
                if (response.ok) {
                    cardDetails[cardId] = await response.json();
                }
            } catch (error) {
                console.error(`Error fetching card ${cardId}:`, error);
            }
        }
        
        // Load category names for display
        let categoriesResponse;
        try {
            categoriesResponse = await fetch(`${API_BASE}/cards/spending-categories/`);
            if (!categoriesResponse.ok) throw new Error('Failed to fetch categories');
        } catch (error) {
            console.error('Error fetching categories:', error);
            categoriesResponse = null;
        }
        
        const categoriesData = categoriesResponse ? await categoriesResponse.json() : [];
        // Handle both paginated (results array) and direct array responses
        const categories = Array.isArray(categoriesData) ? categoriesData : (categoriesData.results || []);
        const categoryMap = {};
        categories.forEach(cat => {
            categoryMap[cat.slug] = cat.display_name || cat.name;
        });
        
        // Build a map of all reward categories from user's cards
        const categoryRewards = {};
        
        for (const cardId of userCards) {
            const card = cardDetails[cardId];
            if (!card || !card.reward_categories) continue;
            
            for (const rewardCategory of card.reward_categories) {
                if (!rewardCategory.is_active) continue;
                
                const categorySlug = rewardCategory.category.slug;
                const categoryName = categoryMap[categorySlug] || rewardCategory.category.display_name || rewardCategory.category.name;
                const rewardRate = parseFloat(rewardCategory.reward_rate);
                const cardName = card.name;
                
                // Track the best rate for each category
                if (!categoryRewards[categorySlug] || rewardRate > categoryRewards[categorySlug].rate) {
                    categoryRewards[categorySlug] = {
                        categoryName: categoryName,
                        rate: rewardRate,
                        cardName: cardName,
                        maxSpend: rewardCategory.max_annual_spend
                    };
                }
            }
        }
        
        if (Object.keys(categoryRewards).length === 0) {
            categoryContainer.innerHTML = `
                <div class="no-data">
                    Your cards don't have specific reward categories. They may earn a flat rate on all purchases.
                </div>
            `;
            return;
        }
        
        // Sort categories alphabetically for consistent display
        const sortedCategories = Object.entries(categoryRewards)
            .sort((a, b) => a[1].categoryName.localeCompare(b[1].categoryName));
        
        let optimizationHtml = '';
        
        for (const [categorySlug, categoryData] of sortedCategories) {
            const { categoryName, rate, cardName, maxSpend } = categoryData;
            
            // Skip general/catch-all categories at 1x rate
            if (rate <= 1.0 && ['other', 'general', 'everything-else'].includes(categorySlug)) {
                continue;
            }
            
            let spendingCapText = '';
            if (maxSpend) {
                spendingCapText = ` (up to $${parseFloat(maxSpend).toLocaleString()}/year)`;
            }
            
            optimizationHtml += `
                <div class="category-optimization-simple">
                    <div class="category-simple-name">${categoryName}</div>
                    <div class="rate-simple">${rate}%</div>
                    <div class="card-simple-name">${cardName}</div>
                    ${spendingCapText ? `<div class="spending-cap-simple">${spendingCapText}</div>` : ''}
                </div>
            `;
        }
        
        if (optimizationHtml === '') {
            categoryContainer.innerHTML = `
                <div class="no-data">
                    Your cards appear to have only general earning rates (1x). Consider adding cards with bonus categories for better optimization.
                </div>
            `;
        } else {
            categoryContainer.innerHTML = optimizationHtml;
        }
        
    } catch (error) {
        console.error('Error loading category optimization:', error);
        document.getElementById('categoryOptimization').innerHTML = `
            <div class="error">Error loading category optimization. Please try refreshing the page.</div>
        `;
    }
}

async function loadSpendingProfile() {
    try {
        const spending = await UserDataManager.getSpending();
        const spendingContainer = document.getElementById('spendingProfile');
        
        if (!spending || Object.keys(spending).length === 0) {
            spendingContainer.innerHTML = `
                <div class="empty-state">
                    <h3>No Spending Profile Set</h3>
                    <p>Set up your spending profile to see detailed analysis and recommendations.</p>
                    <a href="/">Set Up Spending Profile</a>
                </div>
            `;
            return;
        }
        
        // Load category names
        let categoriesResponse;
        try {
            categoriesResponse = await fetch(`${API_BASE}/cards/spending-categories/`);
            if (!categoriesResponse.ok) throw new Error('Failed to fetch categories');
        } catch (error) {
            console.error('Error fetching categories:', error);
            categoriesResponse = null;
        }
        
        const categoriesData = categoriesResponse ? await categoriesResponse.json() : [];
        // Handle both paginated (results array) and direct array responses
        const categories = Array.isArray(categoriesData) ? categoriesData : (categoriesData.results || []);
        const categoryMap = {};
        categories.forEach(cat => {
            categoryMap[cat.slug] = cat.display_name || cat.name;
        });
        
        // Sort spending by amount (highest first)
        const sortedSpending = Object.entries(spending)
            .filter(([, amount]) => parseFloat(amount) > 0)
            .sort((a, b) => parseFloat(b[1]) - parseFloat(a[1]));
        
        if (sortedSpending.length === 0) {
            spendingContainer.innerHTML = `
                <div class="no-data">
                    No spending categories with positive amounts found.
                </div>
            `;
            return;
        }
        
        let spendingHtml = '';
        let totalMonthly = 0;
        
        for (const [categorySlug, monthlyAmount] of sortedSpending) {
            const amount = parseFloat(monthlyAmount);
            const annualAmount = amount * 12;
            totalMonthly += amount;
            
            const categoryName = categoryMap[categorySlug] || categorySlug.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            spendingHtml += `
                <div class="spending-item">
                    <div class="spending-category">${categoryName}</div>
                    <div class="spending-amounts">
                        <div class="monthly-amount">$${amount.toLocaleString('en-US', { maximumFractionDigits: 0 })}/mo</div>
                        <div class="annual-amount">$${annualAmount.toLocaleString('en-US', { maximumFractionDigits: 0 })}/year</div>
                    </div>
                </div>
            `;
        }
        
        // Add total
        spendingHtml += `
            <div class="spending-item" style="border-top: 2px solid #e5e7eb; margin-top: 15px; padding-top: 15px; background: rgba(59, 130, 246, 0.1);">
                <div class="spending-category" style="font-weight: 700; color: #1e40af;">Total Monthly Spending</div>
                <div class="spending-amounts">
                    <div class="monthly-amount" style="color: #1e40af;">$${totalMonthly.toLocaleString('en-US', { maximumFractionDigits: 0 })}/mo</div>
                    <div class="annual-amount">$${(totalMonthly * 12).toLocaleString('en-US', { maximumFractionDigits: 0 })}/year</div>
                </div>
            </div>
        `;
        
        spendingContainer.innerHTML = spendingHtml;

    } catch (error) {
        console.error('Error loading spending profile:', error);
        document.getElementById('spendingProfile').innerHTML = `
            <div class="error">Error loading spending profile. Please try refreshing the page.</div>
        `;
    }
}

async function loadCreditsProfile() {
    try {
        const userCards = await UserDataManager.getCards();
        const creditsContainer = document.getElementById('creditsProfile');

        if (!userCards || userCards.length === 0) {
            creditsContainer.innerHTML = `
                <div class="info-box">
                    <h3>üì± No Cards Added Yet</h3>
                    <p>Add your credit cards above to see all the benefits and credits you're earning!</p>
                </div>
            `;
            return;
        }

        // Fetch detailed card information to get credits
        const cardDetails = {};
        const allCredits = {};

        for (const cardId of userCards) {
            try {
                const response = await fetch(`${API_BASE}/cards/cards/${cardId}/`);
                if (response.ok) {
                    const card = await response.json();
                    cardDetails[cardId] = card;

                    // Collect all credits from this card
                    if (card.credits && card.credits.length > 0) {
                        card.credits.forEach(credit => {
                            const creditType = credit.credit_type;
                            if (creditType) {
                                const creditKey = creditType.slug;
                                if (!allCredits[creditKey]) {
                                    allCredits[creditKey] = {
                                        name: creditType.display_name || creditType.name,
                                        slug: creditType.slug,
                                        totalAmount: 0,
                                        cards: []
                                    };
                                }
                                allCredits[creditKey].totalAmount += parseFloat(credit.amount || 0);
                                allCredits[creditKey].cards.push({
                                    name: card.name,
                                    amount: credit.amount,
                                    frequency: credit.frequency,
                                    description: credit.description
                                });
                            }
                        });
                    }
                }
            } catch (error) {
                console.error(`Error fetching card ${cardId}:`, error);
            }
        }

        // Display credits grouped by type
        const creditEntries = Object.values(allCredits);

        if (creditEntries.length === 0) {
            creditsContainer.innerHTML = `
                <div class="info-box">
                    <h3>‚ÑπÔ∏è No Card Benefits Found</h3>
                    <p>Your current cards don't have any tracked benefits or credits. Consider adding cards with travel credits, statement credits, or other perks!</p>
                </div>
            `;
            return;
        }

        // Sort by total amount (highest first)
        creditEntries.sort((a, b) => b.totalAmount - a.totalAmount);

        let creditsHtml = '<div class="credits-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';

        creditEntries.forEach(credit => {
            const totalAnnualValue = credit.totalAmount;

            creditsHtml += `
                <div class="profile-card" style="border-left: 4px solid #10b981;">
                    <h3 style="margin-top: 0; color: #10b981; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                        ${credit.name}
                        <span style="background: #d1fae5; color: #065f46; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 600;">
                            $${totalAnnualValue.toFixed(0)}/year
                        </span>
                    </h3>
                    <div style="margin-top: 15px;">
                        ${credit.cards.map(card => `
                            <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">${card.name}</div>
                                <div style="color: #10b981; font-size: 14px; font-weight: 600;">$${parseFloat(card.amount).toFixed(0)} ${card.frequency || 'annually'}</div>
                                ${card.description ? `<div style="color: #6b7280; font-size: 13px; margin-top: 4px;">${card.description}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });

        creditsHtml += '</div>';

        // Add total summary
        const totalCreditsValue = creditEntries.reduce((sum, credit) => sum + credit.totalAmount, 0);
        creditsHtml = `
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 500; opacity: 0.9;">Total Annual Benefits Value</h3>
                <div style="font-size: 36px; font-weight: 700;">$${totalCreditsValue.toFixed(0)}</div>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">${creditEntries.length} benefit${creditEntries.length !== 1 ? 's' : ''} across ${Object.keys(cardDetails).length} card${Object.keys(cardDetails).length !== 1 ? 's' : ''}</div>
            </div>
        ` + creditsHtml;

        creditsContainer.innerHTML = creditsHtml;

    } catch (error) {
        console.error('Error loading credits profile:', error);
        document.getElementById('creditsProfile').innerHTML = `
            <div class="error">Error loading benefits. Please try refreshing the page.</div>
        `;
    }
}

async function calculatePortfolioSummary() {
    try {
        const userCards = await UserDataManager.getCards();
        const spending = await UserDataManager.getSpending();
        
        // Initialize default values
        let totalCards = 0;
        let totalAnnualFees = 0;
        let totalAnnualRewards = 0;
        let netPortfolioValue = 0;
        
        if (userCards && userCards.length > 0) {
            // Get detailed card information and calculate fees
            const cardDetails = {};
            for (const cardId of userCards) {
                try {
                    const response = await fetch(`${API_BASE}/cards/cards/${cardId}/`);
                    if (response.ok) {
                        const card = await response.json();
                        cardDetails[cardId] = card;
                        totalAnnualFees += parseFloat(card.annual_fee || 0);
                    }
                } catch (error) {
                    console.error(`Error fetching card ${cardId}:`, error);
                }
            }
            
            totalCards = userCards.length;
            
            // If we have spending data, calculate optimized rewards
            if (spending && Object.keys(spending).length > 0) {
                try {
                    const requestData = {
                        spending: spending,
                        cards: userCards,
                        preferences: await UserDataManager.getPreferences(),
                        max_recommendations: 10
                    };
                    
                    const response = await fetch(`${API_BASE}/roadmaps/quick-recommendation/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const portfolioSummary = data.portfolio_summary;
                        
                        if (portfolioSummary) {
                            totalAnnualRewards = portfolioSummary.total_portfolio_rewards || 0;
                            netPortfolioValue = portfolioSummary.net_portfolio_value || 0;
                            // Use the optimized fees from the portfolio summary if available
                            if (portfolioSummary.total_annual_fees !== undefined) {
                                totalAnnualFees = portfolioSummary.total_annual_fees;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error calculating portfolio optimization:', error);
                    // Fall back to simple calculation
                    netPortfolioValue = Math.max(0, totalAnnualRewards - totalAnnualFees);
                }
            } else {
                // No spending data, so no rewards
                netPortfolioValue = -totalAnnualFees;
            }
        }
        
        // Update the display
        document.getElementById('totalCards').textContent = totalCards.toString();
        document.getElementById('totalAnnualFees').textContent = `$${totalAnnualFees.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
        document.getElementById('totalAnnualRewards').textContent = `$${totalAnnualRewards.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
        
        // Color code the net value
        const netValueElement = document.getElementById('netPortfolioValue');
        netValueElement.textContent = `$${netPortfolioValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
        
        if (netPortfolioValue > 0) {
            netValueElement.style.color = '#059669'; // Green for positive
        } else if (netPortfolioValue < 0) {
            netValueElement.style.color = '#dc2626'; // Red for negative
        } else {
            netValueElement.style.color = '#6b7280'; // Gray for zero
        }
        
    } catch (error) {
        console.error('Error calculating portfolio summary:', error);
        // Show error state
        document.getElementById('totalCards').textContent = 'Error';
        document.getElementById('totalAnnualFees').textContent = 'Error';
        document.getElementById('totalAnnualRewards').textContent = 'Error';
        document.getElementById('netPortfolioValue').textContent = 'Error';
    }
}

function showError(message) {
    const sections = ['cardCollection', 'categoryOptimization', 'spendingProfile'];
    sections.forEach(sectionId => {
        const element = document.getElementById(sectionId);
        if (element && element.innerHTML.includes('Loading')) {
            element.innerHTML = `<div class="error">${message}</div>`;
        }
    });
}

// Profile Privacy and Sharing Functionality
async function initializePrivacySettings() {
    try {
        const response = await fetch('/api/cards/profile/privacy/');
        if (response.ok) {
            const data = await response.json();
            
            // Set the current privacy setting
            const privacyRadio = document.querySelector(`input[name="privacy"][value="${data.privacy_setting}"]`);
            if (privacyRadio) {
                privacyRadio.checked = true;
            }
            
            // Show shareable URL if public
            if (data.is_public && data.shareable_url) {
                showShareableUrl(data.shareable_url);
            }
        }
    } catch (error) {
        console.log('Could not load privacy settings (user may not be logged in)');
    }
}

async function updatePrivacySetting(privacySetting) {
    try {
        const response = await fetch('/api/cards/profile/privacy/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                privacy_setting: privacySetting
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.is_public && data.shareable_url) {
                showShareableUrl(window.location.origin + data.shareable_url);
            } else {
                hideShareableUrl();
            }
            
            // Show success message
            showNotification(privacySetting === 'public' ? 
                'Profile is now public and shareable!' : 
                'Profile is now private', 'success');
        } else {
            const errorData = await response.json();
            showNotification(errorData.error || 'Failed to update privacy setting', 'error');
        }
    } catch (error) {
        showNotification('Error updating privacy setting. Please try again.', 'error');
    }
}

function showShareableUrl(url) {
    const shareableUrlSection = document.getElementById('shareable-url-section');
    const shareableUrlInput = document.getElementById('shareable-url');
    
    shareableUrlInput.value = url;
    shareableUrlSection.style.display = 'block';
}

function hideShareableUrl() {
    const shareableUrlSection = document.getElementById('shareable-url-section');
    shareableUrlSection.style.display = 'none';
}

function copyShareableUrl() {
    const shareableUrlInput = document.getElementById('shareable-url');
    shareableUrlInput.select();
    shareableUrlInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        showNotification('URL copied to clipboard!', 'success');
        
        // Change button text briefly
        const copyBtn = document.getElementById('copy-url-btn');
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '‚úÖ Copied!';
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
        }, 2000);
    } catch (err) {
        showNotification('Failed to copy URL', 'error');
    }
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        transition: all 0.3s ease;
        ${type === 'success' ? 'background: #10b981;' : 
          type === 'error' ? 'background: #ef4444;' : 'background: #3b82f6;'}
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize privacy settings on page load
    initializePrivacySettings();
    
    // Add event listeners for privacy toggle
    const privacyRadios = document.querySelectorAll('input[name="privacy"]');
    privacyRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                updatePrivacySetting(this.value);
            }
        });
    });
});

// Card Search Functionality
let allCards = [];
let selectedCard = null;
let searchTimeout = null;

// Load all cards for search
async function loadAllCards() {
    try {
        const response = await fetch('/api/cards/cards/');
        allCards = await response.json();
    } catch (error) {
        console.error('Error loading cards:', error);
    }
}

// Search cards as user types
function searchCards(query) {
    const resultsDiv = document.getElementById('cardSearchResults');
    const addButton = document.getElementById('addSelectedCard');
    
    // Clear previous timeout
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    // Reset selected card
    selectedCard = null;
    if (addButton) {
        addButton.disabled = true;
        addButton.style.opacity = '0.5';
    }
    
    if (!query || query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    // Debounce search
    searchTimeout = setTimeout(() => {
        const filtered = allCards.filter(card => 
            card.name.toLowerCase().includes(query.toLowerCase()) ||
            card.issuer.name.toLowerCase().includes(query.toLowerCase())
        ).slice(0, 8); // Limit to 8 results
        
        displaySearchResults(filtered);
    }, 300);
}

// Display search results
function displaySearchResults(cards) {
    let resultsDiv = document.getElementById('cardSearchResults');
    
    // Move dropdown to body to escape all stacking contexts
    if (resultsDiv.parentNode !== document.body) {
        document.body.appendChild(resultsDiv);
    }
    
    // Position dropdown relative to search input
    const searchInput = document.getElementById('cardSearch');
    const inputRect = searchInput.getBoundingClientRect();
    
    // Style the dropdown as a portal
    resultsDiv.style.position = 'fixed';
    resultsDiv.style.top = (inputRect.bottom + 2) + 'px';
    resultsDiv.style.left = inputRect.left + 'px';
    resultsDiv.style.width = inputRect.width + 'px';
    resultsDiv.style.zIndex = '10000';
    resultsDiv.style.background = 'white';
    resultsDiv.style.border = '2px solid #e5e7eb';
    resultsDiv.style.borderTop = 'none';
    resultsDiv.style.borderRadius = '0 0 8px 8px';
    resultsDiv.style.maxHeight = '300px';
    resultsDiv.style.overflowY = 'auto';
    resultsDiv.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
    
    if (cards.length === 0) {
        resultsDiv.innerHTML = '<div style="padding: 12px; color: #6b7280; text-align: center;">No cards found</div>';
        resultsDiv.style.display = 'block';
        return;
    }
    
    const html = cards.map(card => `
        <div 
            class="search-result-item" 
            onclick="selectCard(${card.id}, '${card.name.replace(/'/g, '\\\'')}')"
            style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s;"
            onmouseover="this.style.backgroundColor='#f9fafb'"
            onmouseout="this.style.backgroundColor='white'"
        >
            <div>
                <div style="font-weight: 600; color: #1f2937;">${card.name}</div>
                <div style="font-size: 12px; color: #6b7280;">${card.issuer.name} ‚Ä¢ Annual Fee: $${card.annual_fee}</div>
            </div>
            <div style="color: #3b82f6; font-size: 12px; font-weight: 600;">Select ‚Üí</div>
        </div>
    `).join('');
    
    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
}

// Hide search results dropdown
function hideSearchResults() {
    const resultsDiv = document.getElementById('cardSearchResults');
    if (resultsDiv) {
        resultsDiv.style.display = 'none';
    }
}

// Select a card from search results
async function selectCard(cardId, cardName) {
    selectedCard = cardId;
    
    // Update input value
    document.getElementById('cardSearch').value = cardName;
    
    // Hide results and clean up positioning
    const resultsDiv = document.getElementById('cardSearchResults');
    resultsDiv.style.display = 'none';
    
    // Since there's no button, automatically add the card
    await addSelectedCardToCollection();
}

// Add selected card to collection
async function addSelectedCardToCollection() {
    if (!selectedCard) {
        showNotification('Please select a card first', 'error');
        return;
    }
    
    const addButton = document.getElementById('addSelectedCard');
    let originalText = '';
    if (addButton) {
        originalText = addButton.innerHTML;
        addButton.innerHTML = '‚è≥ Adding...';
        addButton.disabled = true;
    }
    
    try {
        if (isAuthenticated) {
            // For authenticated users, save to server
            const response = await fetch('/api/cards/user-cards/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    card_id: selectedCard
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                showNotification(data.message || 'Card added successfully!', 'success');
                
                // Reload the page data to show the new card
                loadProfileData();
            } else {
                const errorData = await response.json();
                showNotification(errorData.error || 'Failed to add card', 'error');
                return;
            }
        } else {
            // For unauthenticated users, save to local storage
            const currentCards = LocalStorage.getCards();
            if (!currentCards.includes(selectedCard)) {
                currentCards.push(selectedCard);
                LocalStorage.setCards(currentCards);
                
                showNotification('Card added to your local collection! Log in to sync with your account.', 'success');
                
                // Reload the page data to show the new card
                loadProfileData();
            } else {
                showNotification('Card is already in your collection', 'info');
            }
        }
        
        // Clear search
        document.getElementById('cardSearch').value = '';
        selectedCard = null;
        if (addButton) {
            addButton.disabled = true;
            addButton.style.opacity = '0.5';
        }
        
    } catch (error) {
        console.error('Error adding card:', error);
        showNotification('Error adding card. Please try again.', 'error');
    } finally {
        if (addButton) {
            addButton.innerHTML = originalText;
            addButton.disabled = selectedCard === null;
        }
    }
}

// Hide search results when clicking outside
document.addEventListener('click', function(event) {
    const searchInput = document.getElementById('cardSearch');
    const resultsDiv = document.getElementById('cardSearchResults');
    
    if (!searchInput.contains(event.target) && !resultsDiv.contains(event.target)) {
        resultsDiv.style.display = 'none';
    }
});

// Load cards when page loads
loadAllCards();

// Update add card section based on authentication status
function updateAddCardSection() {
    const searchInput = document.getElementById('cardSearch');
    const addButton = document.getElementById('addSelectedCard');
    
    // Enable for both authenticated and unauthenticated users
    if (searchInput) {
        searchInput.disabled = false;
        searchInput.style.opacity = '1';
        if (isAuthenticated) {
            searchInput.placeholder = "Type card name (e.g., 'Chase Sapphire', 'Blue Cash')...";
        } else {
            searchInput.placeholder = "Type card name (e.g., 'Chase Sapphire', 'Blue Cash')... (saves locally)";
        }
    }
    
    // Button functionality removed - cards are now added automatically on selection
    
    // Add visual indicator for local storage mode
    if (!isAuthenticated) {
        const addCardSection = document.querySelector('.section h2');
        if (addCardSection && addCardSection.textContent.includes('‚ûï Add Credit Cards')) {
            const existingBadge = addCardSection.querySelector('.local-mode-badge');
            if (!existingBadge) {
                const badge = document.createElement('span');
                badge.className = 'local-mode-badge';
                badge.innerHTML = ' <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">üì± Local Mode</span>';
                addCardSection.appendChild(badge);
            }
        }
    } else {
        // Remove local mode badge for authenticated users
        const badge = document.querySelector('.local-mode-badge');
        if (badge) {
            badge.remove();
        }
    }
}
</script>

{% endblock %}