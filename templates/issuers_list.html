{% extends 'base.html' %}

{% block title %}Card Issuers - Credit Card Guru{% endblock %}

{% block content %}
<h1>🏢 Credit Card Issuers</h1>
<p style="text-align: center; color: #6b7280; margin-bottom: 40px;">
    View all credit card issuers and their policies
</p>

<!-- Filters Section -->
<div class="section">
    <h2>🔍 Filter Issuers</h2>
    <div class="spending-grid">
        <div class="preferences-inline">
            <div class="input-group">
                <span class="input-group-text">Ownership</span>
                <select id="filterOwnership" onchange="filterIssuers()">
                    <option value="all" selected>All Issuers</option>
                    <option value="owned">I have cards from</option>
                    <option value="not_owned">I don't have cards from</option>
                </select>
            </div>
        </div>
        <div class="preferences-inline">
            <div class="input-group">
                <span class="input-group-text">Search Issuers</span>
                <input type="text" id="searchIssuers" placeholder="Search by name..." oninput="filterIssuers()">
            </div>
        </div>
    </div>
</div>

<div id="issuersContainer">
    <div class="loading">🔄 Loading credit card issuers...</div>
</div>

<script>
let allIssuers = [];
let userCards = new Set();

async function loadIssuers() {
    try {
        const response = await fetch(`${API_BASE}/cards/issuers/`);
        const data = await response.json();
        allIssuers = data.results || data;
        
        // Load user's current cards (if any)
        await loadUserCards();
        
        filterIssuers();
        
    } catch (error) {
        console.error('Error loading issuers:', error);
        document.getElementById('issuersContainer').innerHTML = 
            '<div class="error">Error loading issuers. Please try again.</div>';
    }
}

async function loadUserCards() {
    try {
        const cards = await UserDataManager.getCards();
        userCards = new Set(cards);
    } catch (error) {
        console.error('Error loading user cards:', error);
    }
}

async function filterIssuers() {
    const ownershipFilter = document.getElementById('filterOwnership').value;
    const searchFilter = document.getElementById('searchIssuers').value.toLowerCase();
    
    // For ownership filtering, we need to get cards that user owns and their issuers
    let userIssuerIds = new Set();
    if (ownershipFilter !== 'all' && userCards.size > 0) {
        try {
            // Get cards data to find which issuers they have
            const cardsResponse = await fetch(`${API_BASE}/cards/cards/`);
            const cardsData = await cardsResponse.json();
            const cards = cardsData.results || cardsData;
            
            // Filter to user's cards and collect their issuer IDs
            cards.filter(card => userCards.has(card.id))
                 .forEach(card => {
                     if (card.issuer && card.issuer.id) {
                         userIssuerIds.add(card.issuer.id);
                     }
                 });
        } catch (error) {
            console.error('Error loading cards for issuer filtering:', error);
        }
    }
    
    let filteredIssuers = allIssuers.filter(issuer => {
        // Ownership filter
        if (ownershipFilter === 'owned' && !userIssuerIds.has(issuer.id)) {
            return false;
        }
        if (ownershipFilter === 'not_owned' && userIssuerIds.has(issuer.id)) {
            return false;
        }
        
        // Search filter
        if (searchFilter && !issuer.name.toLowerCase().includes(searchFilter)) {
            return false;
        }
        
        return true;
    });
    
    displayIssuers(filteredIssuers);
}

function displayIssuers(issuers) {
    const container = document.getElementById('issuersContainer');
    
    if (issuers.length === 0) {
        container.innerHTML = '<div class="error">No issuers found.</div>';
        return;
    }
    
    const html = issuers.map(issuer => `
        <div class="card-item">
            <div class="card-title">${issuer.name}</div>
            <div class="card-details">
                <p><strong>Card Limit:</strong> Maximum ${issuer.max_cards_per_period} cards per ${issuer.period_months} months</p>
                <p><strong>Policy:</strong> ${issuer.name === 'Chase' ? 'Subject to 5/24 rule and other restrictions' : 'Standard application rules apply'}</p>
                <p><strong>Slug:</strong> ${issuer.slug}</p>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// Load issuers when page loads
loadIssuers();
</script>
{% endblock %}